<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evo Lite v5.5</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; user-select: none; touch-action: none; -webkit-touch-callout: none; transition: filter 2s; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* UI Layers */
        #stats-list { 
            position: absolute; 
            top: 80px; 
            left: 20px; 
            text-align: left; 
            color: rgba(255,255,255,0.7); 
            font-size: 11px; 
            line-height: 1.5; 
            text-shadow: 1px 1px 2px #000; 
            pointer-events: none; 
            font-family: monospace; /* Êï∞ÂÄ§„ÇíÊèÉ„Åà„Çã„Åü„ÇÅÁ≠âÂπÖ„Éï„Ç©„É≥„Éà */
        }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #top-bar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); text-align: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); width: 80%; max-width: 600px; }
        #xp-bg { width: 100%; height: 12px; background: #222; margin-top: 8px; border: 1px solid #555; border-radius: 6px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.5);}
        #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #00ffff, #0088ff); transition: width 0.1s; }
        #skill-list { position: absolute; top: 60px; right: 20px; text-align: right; color: rgba(255,255,255,0.8); font-size: 11px; line-height: 1.4; text-shadow: 1px 1px 2px #000; pointer-events: none; }
        
        #hp-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 300px; text-align: center; color: white; font-weight: bold; pointer-events: none; }
        #hp-bar-bg { width: 100%; height: 16px; background: #330000; border: 2px solid #555; border-radius: 8px; overflow: hidden; margin-top:5px; box-shadow: 0 0 10px #f00; }
        #hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4444, #ff0000); transition: width 0.1s; }
        #hp-regen-text { position: absolute; right: -50px; top: 2px; color: #0f0; font-size: 12px; animation: pulse 1s infinite; }
        @keyframes pulse { 0%{opacity:0.5;} 50%{opacity:1;} 100%{opacity:0.5;} }
        #score-box { position: absolute; top: 20px; left: 20px; color: #fff; font-size: 16px; font-weight: bold; text-shadow: 0 0 5px #000; }
        
        /* Mobile Controls */
        #mobile-controls { display: none; position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
        #joystick-zone { position: absolute; width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; display: none; transform: translate(-50%, -50%); pointer-events: none; }
        #joystick-knob { position: absolute; width: 40px; height: 40px; background: rgba(0, 255, 255, 0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #dash-btn { 
            position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; 
            background: rgba(255, 255, 0, 0.3); border: 2px solid rgba(255, 255, 0, 0.6); 
            border-radius: 50%; pointer-events: auto; display: none;
            justify-content: center; align-items: center; color: #fff; font-size: 30px; user-select: none;
        }
        #dash-btn:active { background: rgba(255, 255, 0, 0.6); transform: scale(0.95); }

        /* Overlays */
        #warning-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 40%, rgba(200,0,0,0.7) 100%); animation: pulseRed 0.2s infinite alternate; justify-content: center; align-items: center; flex-direction: column; z-index: 10; }
        #warning-text { color: #ff0000; font-size: 60px; font-weight: 900; letter-spacing: 5px; text-shadow: 0 0 20px red; transform: scale(1); animation: textZoom 0.1s infinite alternate; text-align: center; }
        #bomb-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 15; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        @keyframes pulseRed { from { opacity: 0.2; } to { opacity: 0.8; } }
        @keyframes textZoom { from { transform: scale(0.95); } to { transform: scale(1.05); } }
        
        #menu-overlay, #start-screen, #game-over { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); pointer-events: auto; z-index: 20; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #start-screen { display: flex; }
        .card-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; max-height: 80vh; overflow-y: auto; padding: 10px; }
        .card { width: 140px; background: #222; border: 1px solid #444; padding: 15px; color: white; cursor: pointer; text-align: center; transition: 0.1s; position: relative; overflow: hidden; border-radius: 8px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
        .card:hover, .card:active { background: #333; border-color: #0ff; transform: translateY(-5px) scale(1.05); box-shadow: 0 0 20px rgba(0,255,255,0.4); }
        
        /* Card Types */
        .card.special { border-color: #ff0; background: #332200; } 
        .card.milestone { border-color: #f0f; background: #220022; }
        .card.milestone:hover { border-color: #fff; background: #440044; box-shadow: 0 0 30px rgba(255,0,255,0.6); }
        
        /* Rare Upgrade Style */
        .card.rare { border-color: #ffd700; background: linear-gradient(135deg, #443300, #221100); box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); animation: glow 2s infinite alternate; }
        .card.rare h3 { color: #ffd700; text-shadow: 0 0 5px #ffaa00; }
        .card.rare p { color: #ffebcd; font-weight: bold; }
        @keyframes glow { from { box-shadow: 0 0 10px #b8860b; } to { box-shadow: 0 0 25px #ffd700; } }

        .card.singularity { border-color: #000; background: #fff; color:#000; box-shadow: 0 0 30px #fff; }
        .card.singularity h3 { color: #000; }
        .card.singularity p { color: #333; }
        
        .card.evo { width: 220px; border-color: #0f0; background: #002211; box-shadow: 0 0 15px #0f0; padding: 20px; }
        .card.evo h3 { color: #0f0; font-size: 18px; margin: 10px 0; border-bottom: 1px solid #0f0; padding-bottom: 5px; width: 100%; }
        .card.evo p { font-size: 12px; color: #dfd; line-height: 1.5; text-align: left; width: 100%; }
        .card.evo .tag { display:inline-block; background:#0f0; color:#000; font-size:10px; padding:2px 5px; border-radius:4px; margin-bottom:5px; font-weight:bold;}

        .card .icon { font-size: 30px; margin-bottom: 5px; display: block; }
        .card h3 { color: #0ff; margin: 5px 0; font-size: 14px; }
        .card.special h3 { color: #ff0; }
        .card.milestone h3 { color: #f0f; }
        .card p { font-size: 11px; color: #ccc; line-height: 1.3; }
        
        button { padding: 20px 50px; font-size: 24px; cursor: pointer; background: #fff; border: none; font-weight: bold; margin-top: 30px; border-radius: 6px; transition: 0.2s; box-shadow: 0 0 10px #fff; }
        button:active { background: #0ff; box-shadow: 0 0 20px #0ff; transform: scale(0.95); }
        
        .singularity-mode #gameCanvas { filter: invert(1) hue-rotate(180deg); }
        .singularity-mode #ui-layer { filter: invert(0); }
    </style>
</head>
<body id="main-body">

<canvas id="gameCanvas"></canvas>

<div id="mobile-controls">
    <div id="joystick-zone"><div id="joystick-knob"></div></div>
    <div id="dash-btn">‚ö°</div>
</div>

<div id="ui-layer">
    <div id="score-box">SCORE: <span id="disp-score">0</span><br>TIME: <span id="disp-time">00:00</span></div>
    
    <div id="stats-list"></div>
    <div id="top-bar">
        <span style="font-size: 20px; font-weight: bold;">LV <span id="disp-lv">1</span> <span id="disp-class-name" style="font-size:12px; color:#aaa;">(Novice)</span></span>
        <div id="xp-bg"><div id="xp-fill"></div></div>
    </div>
    <div id="skill-list"></div>
    <div id="hp-container">
        HP <span id="disp-hp-val">100</span> / <span id="disp-hp-max">100</span>
        <div id="hp-bar-bg"><div id="hp-bar-fill"></div></div>
        <div id="hp-regen-text">+<span id="disp-regen">1</span>/s</div>
    </div>
</div>

<div id="warning-overlay">
    <div id="warning-text">WARNING</div>
    <div style="color:white; font-size:20px; margin-top:10px; font-weight:bold;">BOSS DETECTED</div>
</div>

<div id="bomb-overlay"></div>

<div id="menu-overlay">
    <h1 id="menu-title" style="color:white; font-size:32px; margin-bottom: 20px; text-shadow: 0 0 15px #0ff;">LEVEL UP!</h1>
    <div class="card-container" id="card-area"></div>
</div>

<div id="start-screen">
    <h1 style="font-size:50px; margin:0; letter-spacing: 5px; color:#fff; text-shadow:0 0 20px #0ff; text-align:center;">EVO LITE</h1>
    <h2 style="color:#00ff88; font-weight:normal; font-size:16px;">v5.5</h2>
    <p style="color:#aaa; margin-top:10px; font-size:12px;">PC: WASD + SPACE | Mobile: Touch & Tap</p>
    <button onclick="startGame()">START</button>
</div>

<div id="game-over">
    <h1 style="color:red; font-size:50px; text-shadow: 0 0 20px red;">DEFEATED</h1>
    <p style="font-size:24px; color:white;">SCORE: <span id="final-score"></span></p>
    <button onclick="location.reload()">RETRY</button>
</div>

<script>
// --- Config ---
const MAX_ENEMIES = 500;
const MAX_PARTICLES = 500; 
const MAX_ORBS = 400; 
const MAX_TEXTS = 50;
const MAX_SOUND_CONCURRENT = 32; 
// --- Êïµ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂÆöÁæ©„Éá„Éº„Çø„Éô„Éº„Çπ ---
const ENEMY_DATA = {
    // ID: { baseHp: Âü∫Á§éHP, size: „Çµ„Ç§„Ç∫, color: Ëâ≤, baseSpeed: Âü∫Á§éÈÄüÂ∫¶, ai: AI„Çø„Ç§„Éó, speedMult: ÈÄüÂ∫¶Ë£úÊ≠£(ÁúÅÁï•ÂèØ) }
    boss:    { baseHp: 3000, size: 90, color: '#cc0000', baseSpeed: 2.5, ai: 'boss' },
    golem:   { baseHp: 450,  size: 25, color: '#2F4F4F', baseSpeed: 2.0, ai: 'normal', speedMult: 0.3 }, // „Ç¥„Éº„É¨„É†„ÅØÈÅÖ„ÅÑ
    dasher:  { baseHp: 25,   size: 18, color: '#ff3333', baseSpeed: 2.5, ai: 'dasher' },
    splitter:{ baseHp: 20,   size: 20, color: '#ff3333', baseSpeed: 1.2, ai: 'splitter' },
    bat:     { baseHp: 8,    size: 10, color: '#ff3333', baseSpeed: 5.0, ai: 'bat' },
    shooter: { baseHp: 22,   size: 15, color: '#ff3333', baseSpeed: 1.8, ai: 'shooter' },
    tank:    { baseHp: 80,   size: 24, color: '#ff3333', baseSpeed: 1.0, ai: 'tank' },
    minion:  { baseHp: 8,    size: 10, color: '#ff3333', baseSpeed: 3.0, ai: 'normal' },
    // „Éá„Éï„Ç©„É´„ÉàÔºàÂÆöÁæ©„Åå„Å™„ÅÑÂ†¥ÂêàÁî®Ôºâ
    normal:  { baseHp: 15,   size: 14, color: '#ff3333', baseSpeed: 2.0, ai: 'normal' }
};

// --- „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºàÈÄöÂ∏∏„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºâ„ÅÆÂÆöÁæ© ---
const UPGRADE_DATA = [
    // --- Âü∫Êú¨„Çπ„ÉÜ„Éº„Çø„Çπ (Êù°‰ª∂„Å™„Åó) ---
    { id: 'dmg_p', icon: 'üí™', title: 'ÊîªÊíÉÂäõUP', val: 15, unit: '%', desc: v=>`„ÉÄ„É°„Éº„Ç∏ +${v}%`, 
      func: (v)=> stats.dmg = Math.floor(stats.dmg*(1+v/100)) },
    
    { id: 'hp', icon: '‚ù§Ô∏è', title: 'ÊúÄÂ§ßHP', val: 50, unit: '', desc: v=>`HP +${v}`, 
      func: (v)=> { player.maxHp+=v; player.hp+=v; } },
      
    { id: 'spd', icon: 'üëü', title: 'ÁßªÂãïÈÄüÂ∫¶', val: 2, unit: '', desc: v=>`ÈÄüÂ∫¶ +${v}`, 
      func: (v)=> stats.spd+=v },
      
    { id: 'crit', icon: 'üéØ', title: '„ÇØ„É™„ÉÜ„Ç£„Ç´„É´', val: 5, unit: '%', desc: v=>`‰ºöÂøÉÁéá +${v}%`, 
      func: (v)=> stats.critChance+=v/100 },
      
    { id: 'magnet', icon: 'üß≤', title: 'ÂèéÈõÜÁØÑÂõ≤', val: 50, unit: '', desc: v=>`ÁØÑÂõ≤ +${v}`, 
      func: (v)=> stats.magnet+=v },
      
    { id: 'lightning', icon: 'üå©Ô∏è', title: 'Èõ∑ÊíÉÂº∑Âåñ', val: 1, unit: 'Lv', desc: v=>`Èõ∑ÊíÉ„É¨„Éô„É´ +${v}`, 
      func: (v)=> stats.lightning+=v },
      
    { id: 'rate', icon: '‚ö°', title: '„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥', val: 5, unit: '%', desc: v=>`ÊîªÊíÉÈñìÈöî -${v}%`, 
      func: (v)=> stats.rate = Math.max(2, stats.rate*(1-v/100)) },

    // --- Êù°‰ª∂‰ªò„Åç„Ç¢„Ç§„ÉÜ„É† (conditionÈñ¢Êï∞„Ååtrue„ÅÆÊôÇ„ÅÆ„ÅøÂá∫Áèæ) ---
    
    // ÂõûÂæ©Á≥ª („É¨„Ç¢„Å®ÈÄöÂ∏∏„ÅßID„ÇíÂàÜ„Åë„ÇãÂøÖË¶Å„ÅØ„Å™„Åè„ÄÅ„É≠„Ç∏„ÉÉ„ÇØ„ÅßÂàÜÂ≤ê„ÇÇÂèØËÉΩ„Åß„Åô„Åå„ÄÅ‰ªäÂõû„ÅØ„Ç∑„É≥„Éó„É´„Å´ÂÆöÁæ©)
    { id: 'regen', icon: 'üíñ', title: '„É™„Ç∏„Çß„Éç', val: 2, unit: '', desc: v=>`HPÂõûÂæ© +${v}/s`, 
      func: (v)=> stats.regen+=v, weight: 0.8 }, // weight„ÅßÂá∫ÁèæÁéáË™øÊï¥„ÇÇÂèØËÉΩ
      
    { id: 'drone', icon: 'üõ∞Ô∏è', title: '„Éì„ÉÉ„ÉàÂ¢óË®≠', val: 1, unit: 'Ê©ü', desc: v=>`„Éì„ÉÉ„ÉàÊï∞ +${v}`, 
      func: (v)=> stats.drones+=v, 
      condition: ()=> player.class === 'Sniper' || stats.drones > 0 },
      
    { id: 'missile', icon: 'üöÄ', title: '„Éü„Çµ„Ç§„É´', val: 1, unit: 'Lv', desc: v=>`Áô∫Â∞ÑÊï∞/È†ªÂ∫¶ +${v}`, 
      func: (v)=> stats.missile+=v, 
      condition: ()=> player.class === 'Assault' || stats.missile > 0 },
      
    { id: 'chakram', icon: 'ü•è', title: '„ÉÅ„É£„ÇØ„É©„É†', val: 1, unit: 'ÂÄã', desc: v=>`ÂêåÊôÇÊäïÊì≤Êï∞ +${v}`, 
      func: (v)=> stats.chakram+=v, 
      condition: ()=> player.class === 'Trickster' || stats.chakram > 0 },
      
    // „Éõ„Éº„Éü„É≥„Ç∞: Melee‰ª•Â§ñ„ÄÅ„Åæ„Åü„ÅØÊó¢„Å´ÊåÅ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
    { id: 'homing', icon: 'üëÅÔ∏è', title: '„Éõ„Éº„Éü„É≥„Ç∞', val: 1, unit: 'Lv', desc: v=>`ËøΩÂ∞æÊÄßËÉΩ +${v}`, 
      func: (v)=> stats.homing+=v, 
      condition: ()=> player.class !== 'Melee' || stats.homing > 0 },

    // ÁØÑÂõ≤Êã°Â§ß: ÁâπÂÆö„ÇØ„É©„ÇπÁî®
    { id: 'area', icon: 'üí•', title: 'ÊîªÊíÉÁØÑÂõ≤', val: 10, unit: '%', desc: v=>`„Çµ„Ç§„Ç∫ +${v}%`, 
      func: (v)=> { stats.areaScale += v/100; if(player.class==='Melee') player.size*=1.05; }, 
      condition: ()=> ['Melee','Guardian','Alchemist'].includes(player.class) },
      
    // ÂºæÈÄü: ËøëÊé•‰ª•Â§ñ
    { id: 'bullet_speed', icon: 'üöÖ', title: 'ÂºæÈÄü', val: 10, unit: '%', desc: v=>`Âºæ„ÅÆÈÄü„Åï +${v}%`, 
      func: (v)=> stats.bulletSpeed*=(1+v/100), 
      condition: ()=> !['Melee','Samurai','Guardian'].includes(player.class) },
      
    // Ë≤´ÈÄö: Â∞ÑÊíÉÁ≥ª„ÇØ„É©„Çπ
    { id: 'pierce', icon: 'üèπ', title: 'Ë≤´ÈÄöÂäõ', val: 1, unit: '', desc: v=>`Ë≤´ÈÄöÊï∞ +${v}`, 
      func: (v)=> stats.pierce+=v, 
      condition: ()=> ['Sniper','Assault','Trickster','Tempest','Novice'].includes(player.class) },

    // ÊåÅÁ∂öÊôÇÈñì: Ë®≠ÁΩÆÁ≥ª„Çπ„Ç≠„É´ÊåÅ„Å°
    { id: 'duration', icon: '‚è≥', title: 'ÂäπÊûúÊôÇÈñì', val: 15, unit: '%', desc: v=>`ÊåÅÁ∂öÊôÇÈñì +${v}%`, 
      func: (v)=> stats.duration+=v/100, 
      condition: ()=> player.class==='Alchemist' || player.class==='Guardian' || stats.clusterMine || stats.poison>0 },

    // Èò≤Âæ°Âäõ
    { id: 'armor', icon: 'üõ°Ô∏è', title: 'Ë£ÖÁî≤Âº∑Âåñ', val: 2, unit: '', desc: v=>`Ë¢´„ÉÄ„É°„Éº„Ç∏ -${v}`, 
      func: (v)=> stats.armor+=v, 
      condition: ()=> ['Melee','Samurai','Guardian'].includes(player.class) },

    // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ
    { id: 'knockback', icon: 'ü•ä', title: 'Ë°ùÊíÉÂäõ', val: 1, unit: '', desc: v=>`„Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ +${v}`, 
      func: (v)=> stats.knockback+=v, 
      condition: ()=> ['Melee','Sniper','Assault','Novice'].includes(player.class) },

    // „Éû„É´„ÉÅ„Ç∑„Éß„ÉÉ„ÉàÁ≥ª
    { id: 'multi_blade', icon: '‚öîÔ∏è', title: 'ÂõûËª¢ÂàÉ+', val: 1, unit: '', desc: v=>`ÂõûËª¢ÂàÉ„ÅÆÊï∞ +${v}`, 
      func: (v)=> stats.multi+=v, condition: ()=> player.class === 'Melee' },
      
    { id: 'multi_wave', icon: 'üåä', title: 'Ë°ùÊíÉÊ≥¢+', val: 1, unit: '', desc: v=>`Ë°ùÊíÉÊ≥¢„ÅÆÊï∞ +${v}`, 
      func: (v)=> stats.multi+=v, condition: ()=> player.class === 'Samurai' },
      
    { id: 'multi_shot', icon: 'üî´', title: '„Éû„É´„ÉÅ„Ç∑„Éß„ÉÉ„Éà', val: 1, unit: '', desc: v=>`ÂêåÊôÇÁô∫Â∞ÑÊï∞ +${v}`, 
      func: (v)=> stats.multi+=v, 
      condition: ()=> !['Melee','Samurai'].includes(player.class) }
];

// --- Á¶ÅÊñ≠„ÅÆÂäõÔºàMilestoneÔºâ„ÅÆÂÆöÁæ© ---
// classes: null„Å™„ÇâÂÖ®Âì°„ÄÅ['Sniper']„Å™„Çâ„Çπ„Éä„Ç§„Éë„ÉºÂ∞ÇÁî®
// isOwned: true„ÇíËøî„Åô„Å®„É™„Çπ„Éà„Å´Âá∫Áèæ„Åó„Å™„Åè„Å™„ÇãÔºàÂèñÂæóÊ∏à„Åø„ÉÅ„Çß„ÉÉ„ÇØÔºâ
const MILESTONE_DATA = [
    // === ÂÖ±ÈÄö (Common) ===
    { title: "‚ö° „Ç™„É°„Ç¨„Éª„É¨„Éº„Ç∂„Éº", desc: "3Áßí„Åî„Å®„Å´ÁîªÈù¢„ÇíËñô„ÅéÊâï„ÅÜÊ•µÂ§™„É¨„Éº„Ç∂„Éº„ÇíÁô∫Â∞Ñ„ÄÇ", 
      classes: null, isOwned: ()=>stats.omegaLaser, f:()=>{stats.omegaLaser=true;} },
    { title: "‚ùÑÔ∏è „Ç¢„Éñ„ÇΩ„É™„É•„Éº„Éà„Éª„Çº„É≠", desc: "Âë®Âõ≤„ÅÆÊïµ„ÇíÂáçÁµê„Åï„Åõ„ÄÅÈï∑ÊôÇÈñìÂÅúÊ≠¢„Åï„Åõ„Çã„Ç™„Éº„É©„ÄÇ", 
      classes: null, isOwned: ()=>stats.absoluteZero, f:()=>{stats.absoluteZero=true;} },
    { title: "üíÄ „Éç„ÇØ„É≠„Éû„É≥„Çµ„Éº", desc: "ÊïµÊíÉÁ†¥ÊôÇ„Å´„ÄÅÊïµ„ÇíËøΩÂ∞æ„Åô„ÇãÊÄ®ÈúäÂºæ„ÇíÂè¨Âñö„Åô„Çã„ÄÇ", 
      classes: null, isOwned: ()=>stats.necromancer, f:()=>{stats.necromancer=true;} },
    { title: "ü©∏ Ë°Ä„ÅÆÂ•ëÁ¥Ñ", desc: "ÊúÄÂ§ßHP„Åå1„Å´„Å™„Çã‰ª£„Çè„Çä„Å´„ÄÅÊîªÊíÉÂäõ„Åå5ÂÄç„Å´„Å™„Çã„ÄÇ", 
      classes: null, isOwned: ()=>player.maxHp===1, f:()=>{player.maxHp=1; player.hp=1; stats.dmg*=5;} },
    { title: "üõ°Ô∏è „Ç¥„ÉÉ„Éâ„É¢„Éº„Éâ", desc: "Ë¢´ÂºæÊôÇ„ÅÆÁÑ°ÊïµÊôÇÈñì„Åå3ÂÄç„Å´„Å™„Çã„ÄÇ", 
      classes: null, isOwned: ()=>player.invincibleMax>=60, f:()=>{player.invincibleMax=60;} },
    { title: "üë• „Éâ„ÉÉ„Éö„É´„Ç≤„É≥„Ç¨„Éº", desc: "ËÉåÂæå„Å´ÂàÜË∫´„ÅåÂá∫Áèæ„Åó„ÄÅÂèçÂØæÊñπÂêë„Å∏ÂêåÊôÇ„Å´ÊîªÊíÉ„Åô„Çã„ÄÇ", 
      classes: null, isOwned: ()=>stats.doppelganger, f:()=>{stats.doppelganger=true;} },
    { title: "‚è≥ „Ç∂„Éª„ÉØ„Éº„É´„Éâ", desc: "„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Çã„Å®ÊôÇ„ÅåÊ≠¢„Åæ„Çä„ÄÅÂõûÈÅø„ÅÆ„ÉÅ„É£„É≥„Çπ„ÇíÂæó„Çã(CD„ÅÇ„Çä)„ÄÇ", 
      classes: null, isOwned: ()=>stats.timeStop, f:()=>{stats.timeStop=true;} },
    { title: "üß¨ „Ç∏„É£„Ç§„Ç¢„É≥„Éà„Ç≠„É©„Éº", desc: "ÊîªÊíÉÊôÇ„ÄÅÊïµ„ÅÆÊúÄÂ§ßHP„ÅÆ2%ÂàÜ„ÅÆËøΩÂä†„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ", 
      classes: null, isOwned: ()=>false, f:()=>{stats.hpDamage += 0.02;} }, // ÈáçË§áÂèØ
    { title: "üéØ „Éï„Çß„Ç§„Çø„É´„Éª„ÇØ„É™„ÉÜ„Ç£„Ç´„É´", desc: "„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÉÄ„É°„Éº„Ç∏ÂÄçÁéá +50%", 
      classes: null, isOwned: ()=>stats.critMult >= 10.0, f:()=>{stats.critMult += 0.5;} },
    { title: "ü©∏ ÈÆÆË°Ä„ÅÆÁà™", desc: "Â§±„Å£„ÅüHPÂâ≤Âêà„Å´Âøú„Åò„Å¶ÊîªÊíÉÂäõ„Åå‰∏äÊòá„Åô„Çã (ËÉåÊ∞¥)", 
      classes: null, isOwned: ()=>stats.lowHpDmg, f:()=>{stats.lowHpDmg = true;} },

    // === „Ç¢„Çµ„É´„Éà (Assault) ===
    { title: "üí£ ÁàÜË£ÇÂºæ", desc: "ÂÖ®„Å¶„ÅÆÈÄöÂ∏∏Âºæ„ÅåÁùÄÂºæÊôÇ„Å´ÁàÜÁô∫„Åô„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.shotExplode, f:()=>{stats.shotExplode=true;} },
    { title: "‚Ü©Ô∏è Ë∑≥Âºæ", desc: "Âºæ„ÅåÁîªÈù¢Á´Ø„ÅßË∑≥„Å≠Ëøî„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.shotBounce, f:()=>{stats.shotBounce=true;} },
    { title: "üëØ „ÉÄ„Éñ„É´„Éà„É™„Ç¨„Éº", desc: "50%„ÅÆÁ¢∫Áéá„Åß„ÄÅ‰∏ÄÂ∫¶„Å´2Áô∫„ÅÆÂºæ„ÇíÁô∫Â∞Ñ„Åô„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.doubleShot, f:()=>{stats.doubleShot=true;} },
    { title: "üöÄ „Éü„Çµ„Ç§„É´Á•≠", desc: "Â∞ÑÊíÉÊôÇ„Å´20%„ÅÆÁ¢∫Áéá„ÅßËøΩÂä†„Éü„Çµ„Ç§„É´„ÇíÁô∫Â∞Ñ„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.missileChance>=0.2, f:()=>{stats.missileChance=0.2;} },
    { title: "‚ôæÔ∏è ÁÑ°Èôê„Éû„Ç¨„Ç∏„É≥", desc: "‰∏ÄÂ∫¶„ÅÆÁô∫Â∞ÑÊï∞+3„ÄÇ„É™„É≠„Éº„ÉâÊôÇÈñì„Åå„Çº„É≠„Å´„Å™„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.infiniteMag, f:()=>{stats.infiniteMag=true;} },
    { title: "‚öôÔ∏è „Ç¨„Éà„É™„É≥„Ç∞", desc: "ÈÄ£Â∞ÑÈÄüÂ∫¶„ÅåÈôêÁïåÁ™ÅÁ†¥„Åó„ÄÅÂáÑ„Åæ„Åò„ÅÑÂºæÂπï„ÇíÂºµ„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.gatling, f:()=>{stats.rate=Math.max(1, stats.rate-10); stats.gatling=true;} },
    { title: "üî• „Ç™„Éº„Éê„Éº„Éí„Éº„Éà", desc: "ÊíÉ„Å°Á∂ö„Åë„Çã„Å®ÈÄ£Â∞ÑÈÄüÂ∫¶„Åå‰∏ä„Åå„Çã„Åå„ÄÅËá™ÂàÜ„ÅåÂÉÖ„Åã„Å´„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.overheat, f:()=>{stats.overheat=true;} },
    { title: "ü¶∂ „É™„Ç≥„Ç§„É´„Ç∏„É£„É≥„Éó", desc: "Â∞ÑÊíÉ„ÅÆÂèçÂãï„ÅßÂæå„Çç„Å´‰∏ã„Åå„Çã„Çà„ÅÜ„Å´„Å™„Çä„ÄÅÊ©üÂãïÂäõ„Åå‰∏ä„Åå„Çã„ÄÇ", 
      classes: ['Assault'], isOwned: ()=>stats.recoilJump, f:()=>{stats.recoilJump=true;} },

    // === „É¥„Ç°„É≥„Ç¨„Éº„Éâ (Melee) ===
    { title: "ü¶ç „Çø„Ç§„Çø„É≥", desc: "HP2ÂÄç„ÄÅ„Çµ„Ç§„Ç∫1.5ÂÄç„ÄÇÊîªÊíÉÂà§ÂÆö„ÇÇÂ∑®Â§ßÂåñ„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.titan, f:()=>{player.maxHp*=2; player.hp*=2; player.size*=1.5; stats.titan=true;} },
    { title: "‚ö´ „Éñ„É©„ÉÉ„ÇØ„Éõ„Éº„É´", desc: "„Ç™„Éº„É©„ÅåÊïµ„ÇíÂº∑Âäõ„Å´Âê∏„ÅÑÂØÑ„Åõ„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.blackHole, f:()=>{stats.blackHole=true;} },
    { title: "‚öîÔ∏è „Éñ„É¨„Éº„Éâ„Çπ„Éà„Éº„É†", desc: "ÂõûËª¢ÂàÉ„ÅÆÊûöÊï∞„Åå+4ÊûöËøΩÂä†„Åï„Çå„Çã„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.bladeStorm, f:()=>{stats.bladeStorm=true;} },
    { title: "üåé „Ç¢„Éº„Çπ„ÇØ„Ç®„Ç§„ÇØ", desc: "2Áßí„Åî„Å®„Å´ÁîªÈù¢ÂÖ®‰ΩìÊîªÊíÉ„ÇíË°å„ÅÑ„ÄÅÊïµ„ÇíÊ∞óÁµ∂„Åï„Åõ„Çã„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.earthquake, f:()=>{stats.earthquake=true;} },
    { title: "üåµ „Çπ„Éë„Ç§„ÇØ„É™„Éï„É¨„ÇØ„Éà", desc: "ÊïµÊé•Ëß¶ÊôÇ„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí2ÂÄç„Å´„Åó„Å¶ÂèçÂ∞Ñ„Åô„Çã„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.spikeReflect, f:()=>{stats.spikeReflect=true;} },
    { title: "üßõ „Éñ„É©„ÉÉ„Éâ„É©„Çπ„Éà", desc: "Êïµ„ÇíÂÄí„Åô„Å®HP„Åå1%ÂõûÂæ©„Åô„Çã„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.bloodLust, f:()=>{stats.bloodLust=true;} },
    { title: "ü§∫ „Éë„É™„Ç£", desc: "15%„ÅÆÁ¢∫Áéá„Åß„ÉÄ„É°„Éº„Ç∏„ÇíÁÑ°ÂäπÂåñ„Åó„ÄÅÂë®Âõ≤„ÇíÂêπ„ÅçÈ£õ„Å∞„Åô„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.parry, f:()=>{stats.parry=true;} },
    { title: "üåä „ÇΩ„Éº„Éâ„Ç¶„Çß„Éº„Éñ", desc: "ÂõûËª¢ÂàÉ„Åã„ÇâÂÆöÊúüÁöÑ„Å´ÁúüÁ©∫Ê≥¢„ÅåÈ£õ„Å≥„ÄÅÈÅ†„Åè„ÅÆÊïµ„ÇíÊñ¨„Çã„ÄÇ", 
      classes: ['Melee'], isOwned: ()=>stats.swordWave, f:()=>{stats.swordWave=true;} },

    // === „Çπ„Éä„Ç§„Éë„Éº (Sniper) ===
    { title: "üöÖ „É¨„Éº„É´„Ç¨„É≥", desc: "ÂºæÈÄü2ÂÄç„ÄÅ„Çµ„Ç§„Ç∫2ÂÄç„ÄÇÂÖ®„Å¶„ÅÆÊïµ„ÇíË≤´ÈÄö„Åô„Çã„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.railgun, f:()=>{stats.bulletSpeed*=2; stats.railgun=true; stats.infinitePierce=true;} },
    { title: "üî™ Âá¶Âàë‰∫∫", desc: "HP30%‰ª•‰∏ã„ÅÆÊïµ„Å´ÊîªÊíÉ„Åô„Çã„Å®Âç≥Ê≠ª„Åï„Åõ„Çã„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.execute, f:()=>{stats.execute=true;} },
    { title: "üëÅÔ∏è „Éá„ÉÉ„Éâ„Ç¢„Ç§", desc: "ÂÖ®„Å¶„ÅÆÊîªÊíÉ„Åå„ÇØ„É™„ÉÜ„Ç£„Ç´„É´(3ÂÄç„ÉÄ„É°„Éº„Ç∏)„Å´„Å™„Çã„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.deadeye, f:()=>{stats.deadeye=true;} },
    { title: "‚ö° „Ç®„É¨„ÇØ„Éà„É≠„Éï„Çß„É≥„Çπ", desc: "Âë®Âõ≤„ÅÆÊïµ„ÇíÈ∫ªÁó∫„Åï„Åõ„ÄÅÂºæ„ÅçÈ£õ„Å∞„ÅôÈõªÊ∞óÊüµ„ÇíÂ±ïÈñã„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.electroFence, f:()=>{stats.electroFence=true;} },
    { title: "üí• „ÉÅ„Çß„Éº„É≥„Éê„Éº„Çπ„Éà", desc: "Êïµ„ÇíÂÄí„Åô„Å®ÈÄ£ÈéñÁàÜÁô∫„ÅåÁô∫Áîü„Åó„ÄÅÂë®Âõ≤„ÇíÂ∑ª„ÅçËæº„ÇÄ„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.chainBurst, f:()=>{stats.chainBurst=true;} },
    { title: "‚òÑÔ∏è Â§©ÁΩ∞", desc: "„É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„Å´Âº∑Âäõ„Å™Ë°õÊòü„É¨„Éº„Ç∂„Éº„ÅåÈôç„ÇäÊ≥®„Åê„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.orbital, f:()=>{stats.orbital=true;} },
    { title: "üëª „Éï„Ç°„É≥„Éà„É†„Éê„É¨„ÉÉ„Éà", desc: "Â£Å„ÇÑÊïµ„Çí„Åô„ÇäÊäú„Åë„ÄÅÁîªÈù¢Â§ñ„Åã„ÇâÊàª„Å£„Å¶„Åè„ÇãÈ≠îÊ≥ï„ÅÆÂºæ‰∏∏„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.phantom, f:()=>{stats.phantom=true; stats.ghostShot=true;} },
    { title: "üéØ „Çµ„Éº„Éû„É´„Çπ„Ç≥„Éº„Éó", desc: "ÁîªÈù¢Â§ñ„ÅÆÊïµ„Å´„ÇÇ„Éõ„Éº„Éü„É≥„Ç∞„ÅåÈÅ©Áî®„Åï„Çå„ÄÅ„ÇØ„É™„ÉÜ„Ç£„Ç´„É´Áéá„Åå‰∏ä„Åå„Çã„ÄÇ", 
      classes: ['Sniper'], isOwned: ()=>stats.thermal, f:()=>{stats.thermal=true; stats.homing+=2;} },

    // === „Ç¨„Éº„Éá„Ç£„Ç¢„É≥ (Guardian) ===
    { title: "üèóÔ∏è „Çª„É≥„Éà„É™„Éº„Ç∑„Çπ„ÉÜ„É†", desc: "10Áßí„Åî„Å®„Å´Ëá™ÂãïÊîªÊíÉ„Çø„É¨„ÉÉ„Éà„ÇíË®≠ÁΩÆ„Åô„Çã„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.sentrySystem, f:()=>{stats.sentrySystem=true; spawnSentry();} },
    { title: "üèØ „Ç∑„Éº„Ç∏„É¢„Éº„Éâ", desc: "Á´ã„Å°Ê≠¢„Åæ„Å£„Å¶„ÅÑ„ÇãÈñì„ÄÅÊîªÊíÉÈÄüÂ∫¶„Å®„ÉÄ„É°„Éº„Ç∏„Åå2ÂÄç„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.siegeMode, f:()=>{stats.siegeMode=true;} },
    { title: "‚ö° „É™„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç¢„Éº„Éû„Éº", desc: "„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Çã„Å®„ÄÅÂë®Âõ≤„Å´ÈõªÊíÉ„Ç´„Ç¶„É≥„Çø„Éº„ÇíÊîæ„Å§„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.reactiveArmor, f:()=>{stats.reactiveArmor=true;} },
    { title: "‚ù§Ô∏è „Éä„Éé„Éû„Ç∑„É≥‰øÆÂæ©", desc: "HP„Åå30%‰ª•‰∏ã„Å´„Å™„Çã„Å®Ë∂ÖÈ´òÈÄü„ÅßËá™ÁÑ∂ÂõûÂæ©„Åô„Çã„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.nanoRepair, f:()=>{stats.nanoRepair=true;} },
    { title: "üí£ „ÇØ„É©„Çπ„Çø„Éº„Éû„Ç§„É≥", desc: "„ÉÄ„ÉÉ„Ç∑„É•ÊôÇ„Å´Â§ßÈáè„ÅÆÂú∞Èõ∑„Çí„Å∞„ÇâÊíí„Åè„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.clusterMine, f:()=>{stats.clusterMine=true;} },
    { title: "üõ°Ô∏è „Éï„Ç©„Éº„Çπ„Éï„Ç£„Éº„É´„Éâ", desc: "ÂÆöÊúüÁöÑ„Å´„ÉÄ„É°„Éº„Ç∏„ÇíÂÆåÂÖ®ÁÑ°ÂäπÂåñ„Åô„Çã„Éê„É™„Ç¢„ÇíÂ±ïÈñã„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.forceField, f:()=>{stats.forceField=true;} },
    { title: "üöÅ Ë≠∑Ë°õ„Éâ„É≠„Éº„É≥", desc: "„Éó„É¨„Ç§„É§„Éº„ÅÆÂë®Âõ≤„ÇíÊóãÂõû„Åó„ÄÅËøë„Å•„ÅèÊïµ„ÇíËøéÊíÉ„Åô„Çã„Éâ„É≠„Éº„É≥„ÇíÈÖçÂÇô„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.guardDrone, f:()=>{stats.guardDrone=true;} },
    { title: "üè∞ ÁßªÂãïË¶ÅÂ°û", desc: "ÁßªÂãïÈÄüÂ∫¶„ÅåÂçäÊ∏õ„Åô„Çã‰ª£„Çè„Çä„Å´„ÄÅÈò≤Âæ°Âäõ„Å®HP„ÅåÂ§ßÂπÖ„Å´‰∏äÊòá„Åô„Çã„ÄÇ", 
      classes: ['Guardian'], isOwned: ()=>stats.armor>=25, f:()=>{stats.spd*=0.5; stats.armor+=10; player.maxHp+=500; player.hp+=500;} },

    // === „Ç¢„É´„Ç±„Éü„Çπ„Éà (Alchemist) ===
    { title: "‚ò£Ô∏è „Éë„É≥„Éá„Éü„ÉÉ„ÇØ", desc: "ÊØí„ÇíÂèó„Åë„ÅüÊïµ„ÅåÊ≠ª„Å¨„Å®„ÄÅ„Åù„ÅÆÂ†¥„Å´ÊØí„Ç¨„Çπ„ÇíÁô∫Áîü„Åï„Åõ„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.pandemic, f:()=>{stats.pandemic=true;} },
    { title: "üß™ Á•ûÁµåÊØí", desc: "ÊØí„Ç¨„Çπ„ÅÆÁØÑÂõ≤ÂÜÖ„Å´„ÅÑ„ÇãÊïµ„ÅÆÁßªÂãïÈÄüÂ∫¶„ÇíÂ§ßÂπÖ„Å´‰∏ã„Åí„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.neurotoxin, f:()=>{stats.neurotoxin=true;} },
    { title: "üßä „Ç≥„Éº„É´„Éâ„Éï„É©„Çπ„Ç≥", desc: "ÊîªÊíÉÊôÇ„ÄÅ10%„ÅÆÁ¢∫Áéá„ÅßÊïµ„ÇíÂáçÁµê„Åï„Åõ„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.coldFlask, f:()=>{stats.coldFlask=true;} },
    { title: "ü§¢ ËÖêÈ£üÊ∂≤", desc: "ÊØí„Ç¨„Çπ„ÅÆ„ÉÄ„É°„Éº„Ç∏ÈñìÈöî„ÅåÂçäÂàÜ„Å´„Å™„Çä„ÄÅÁÅ´Âäõ„ÅåÂÄçÂ¢ó„Åô„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.corrosion, f:()=>{stats.corrosion=true;} },
    { title: "üíä ÈÅïÊ≥ï„Å™ËààÂ•ÆÂâ§", desc: "ÁßªÂãïÈÄüÂ∫¶+20„ÄÅÈÄ£Â∞ÑÈÄüÂ∫¶+20%„ÄÇ„Åü„Å†„ÅóË¢´„ÉÄ„É°„Éº„Ç∏„Åå1.5ÂÄç„Å´„Å™„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.drugMode, f:()=>{stats.spd+=20; stats.rate-=5; stats.armor-=5; stats.drugMode=true;} },
    { title: "üåßÔ∏è „Ç¢„Ç∑„ÉÉ„Éâ„É¨„Ç§„É≥", desc: "3Áßí„Åî„Å®„Å´„É©„É≥„ÉÄ„É†„Å™Â†¥ÊâÄ„Å´Âº∑Âäõ„Å™ÈÖ∏„ÅÆÈõ®ÔºàÊØíÊ≤ºÔºâ„ÇíÈôç„Çâ„Åõ„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.acidRain, f:()=>{stats.acidRain=true;} },
    { title: "üßü „Çæ„É≥„Éì„Ç¶„Ç§„É´„Çπ", desc: "ÂÄí„Åó„ÅüÊïµ„Åå‰∏ÄÂÆöÁ¢∫Áéá„ÅßÂë≥Êñπ„ÅÆ„Éü„Éã„Ç™„É≥„Å®„Åó„Å¶Âæ©Ê¥ª„Åô„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.zombieVirus, f:()=>{stats.zombieVirus=true;} },
    { title: "‚öóÔ∏è „Ç±„Éü„Ç´„É´„Éª„Éê„Éº„É≥", desc: "ÊØíÁä∂ÊÖã„ÅÆÊïµ„Å´ÊîªÊíÉ„Åô„Çã„Å®„ÄÅËøΩÂä†„ÅßÁàÜÁô∫„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ", 
      classes: ['Alchemist'], isOwned: ()=>stats.chemicalBurn, f:()=>{stats.chemicalBurn=true;} },

    // === „Éà„É™„ÉÉ„ÇØ„Çπ„Çø„Éº (Trickster) ===
    { title: "üé∞ „Çπ„É≠„ÉÉ„Éà„Éû„Ç∑„É≥", desc: "5Áßí„Åî„Å®„Å´„É©„É≥„ÉÄ„É†„Å™„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÂäáÁöÑ„Å´Â§âÂåñ„Åô„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.slotMachine, f:()=>{stats.slotMachine=true;} },
    { title: "üÉè „Ç∏„Éß„Éº„Ç´„Éº", desc: "HP„ÅåÊ∏õ„Çã„Åª„Å©„ÄÅ„ÇØ„É™„ÉÜ„Ç£„Ç´„É´Áéá„Å®ÂõûÈÅøÁéá„ÅåË∂Ö‰∏äÊòá„Åô„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.joker, f:()=>{stats.joker=true;} },
    { title: "üé≤ „É≠„Ç∑„Ç¢„É≥„É´„Éº„É¨„ÉÉ„Éà", desc: "1/6„ÅÆÁ¢∫Áéá„Åß„ÉÄ„É°„Éº„Ç∏„Åå10ÂÄç„Å´„Å™„Çã„Åå„ÄÅ„Åü„Åæ„Å´‰∏çÁô∫„Å´„Å™„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.russianRoulette, f:()=>{stats.russianRoulette=true;} },
    { title: "‚ú® „Éû„Ç∏„ÉÉ„ÇØ„Ç´„Éº„Éâ", desc: "Âºæ„ÅåÊïµ„ÇíË≤´ÈÄö„Åó„ÄÅÂ£Å„ÅßË∑≥„Å≠Ëøî„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.shotBounce, f:()=>{stats.pierce+=2; stats.shotBounce=true;} },
    { title: "üí∞ „Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà", desc: "Êïµ„ÇíÂÄí„Åó„ÅüÊôÇ„ÄÅÁ®Ä„Å´Â§ßÈáè„ÅÆÁµåÈ®ìÂÄ§„Ç™„Éº„Éñ„ÅåÁàÜÁô∫ÂõõÊï£„Åô„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.jackpot, f:()=>{stats.jackpot=true;} },
    { title: "üåÄ „Ç´„Ç™„ÇπÂºæ", desc: "Âºæ„Åå‰∏çË¶èÂâá„Å´ËõáË°å„Åó„ÄÅ„Çµ„Ç§„Ç∫„ÇÇ„Éê„É©„Éê„É©„Å´„Å™„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.chaosShot, f:()=>{stats.chaosShot=true;} },
    { title: "üé≤ „É©„ÉÉ„Ç≠„Éº„Çª„Éñ„É≥", desc: "7Áô∫„Åî„Å®„ÅÆÊîªÊíÉ„ÅåÂøÖ„Åö„ÇØ„É™„ÉÜ„Ç£„Ç´„É´ÔºÜÁØÑÂõ≤ÊîªÊíÉ„Å´„Å™„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.luckySeven, f:()=>{stats.luckySeven=true;} },
    { title: "üÉè „ÉØ„Ç§„É´„Éâ„Ç´„Éº„Éâ", desc: "‰ªñ„ÅÆ„ÇØ„É©„Çπ„ÅÆÁ¶ÅÊñ≠„ÅÆÂäõÔºà„Çπ„Ç≠„É´Ôºâ„Åå„É©„É≥„ÉÄ„É†„Åß1„Å§Áô∫Âãï„Åô„Çã„ÄÇ", 
      classes: ['Trickster'], isOwned: ()=>stats.wildCard, f:()=>{stats.wildCard=true;} }
];

// --- Á¨¨1Ê¨°ÈÄ≤Âåñ (Level 5) ---
const EVO_DATA = [
    { id: 'Samurai', icon: '‚öîÔ∏è', title: '‰æç„ÉªÂâ£Ë±™', desc: '‰∏ÄÈñÉ: Â∞ÑÁ®ã„ÅØÁü≠„ÅÑ„Åå„ÄÅÂâçÊñπ„ÅÆÊïµ„Çí‰∏ÄÁû¨„ÅßËë¨„Çã„ÄåÊñ¨ÊíÉ„Äç„ÇíÊîæ„Å§„ÄÇ', 
      color: '#ffffff', func: ()=>{
        stats.samuraiMode = true; stats.rate = 20; stats.dmg = 300; 
        stats.spd += 5; stats.pierce = 999; stats.knockback = 0;
      }},
    { id: 'Tempest', icon: '‚ö°', title: 'Èõ∑Â∏ù', desc: 'Â§©Â§âÂú∞Áï∞: Â∏∏„Å´Âë®Âõ≤„Å´ËêΩÈõ∑„ÅåÁô∫Áîü„Åó„ÄÅÊîªÊíÉÂºæ„ÇÇÈÄ£ÈéñÈõ∑ÊíÉ„ÇíÂºï„ÅçËµ∑„Åì„Åô„ÄÇ', 
      color: '#8A2BE2', func: ()=>{
        stats.tempestMode = true; stats.rate = 8; stats.dmg = 15; 
        stats.lightning = 3; stats.bulletSpeed = 25;
      }},
    { id: 'Assault', icon: 'üî´', title: '„Ç¢„Çµ„É´„Éà', desc: 'ÈÄ£Â∞ÑÁâπÂåñ: „Éû„Ç∑„É≥„Ç¨„É≥(ÈÄ£Â∞Ñ„Éª2Áô∫„ÉªË≤´ÈÄö)Ëß£Á¶Å', 
      color: '#00ffff', func: ()=>{
        stats.rate=4; stats.dmg+=10; stats.multi=1; stats.pierce=1;
      }},
    { id: 'Melee', icon: 'üõ°Ô∏è', title: '„É¥„Ç°„É≥„Ç¨„Éº„Éâ', desc: 'ËøëÊé•: Ë∂Ö„ÉªÂ∫ÉÁØÑÂõ≤ & HP+500/„É™„Ç∏„Çß„Éç+10', 
      color: '#ff3333', func: ()=>{
        stats.aura=true; stats.auraRange=180; stats.spd+=4; 
        player.maxHp+=500; player.hp+=500; stats.regen+=10;
      }},
    { id: 'Sniper', icon: 'üî≠', title: '„Çπ„Éä„Ç§„Éë„Éº', desc: 'ÈÅ†Ë∑ùÈõ¢: üí•Á†¥Áâá & üîô„Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ', 
      color: '#ffff00', func: ()=>{
        stats.rate=35; stats.dmg=200; stats.pierce=2; stats.bulletSpeed=30; stats.multi=0;
        stats.drones+=1; stats.shrapnel=true; stats.knockback=1;
      }},
    { id: 'Guardian', icon: 'üß±', title: '„Ç¨„Éº„Éá„Ç£„Ç¢„É≥', desc: 'Ê©üÂãïË¶ÅÂ°û: „Çø„É¨„ÉÉ„Éà8Âü∫Â±ïÈñã„ÉªÂèçÂ∞ÑË£ÖÁî≤„ÉªÈ´òËÄê‰πÖ', 
      color: '#00ff88', func: ()=>{
        stats.armor+=20; player.maxHp+=1500; player.hp=player.maxHp; 
        stats.spd-=0.5; stats.magnet+=200; stats.sentryRate=2.5; 
        stats.sentryMax=6; stats.sentrySystem=true; spawnSentry(); stats.spikeReflect=true;
      }},
    { id: 'Alchemist', icon: '‚öóÔ∏è', title: '„Ç¢„É´„Ç±„Éü„Çπ„Éà', desc: 'ÊØíÁâ©ÂäáÁâ©: ÊØí„Ç¨„Çπ„ÉªÂáçÁµê„ÉªÂº±‰ΩìÂåñ„Çí„Éê„É©Êíí„Åè', 
      color: '#aa00ff', func: ()=>{
        stats.poison = 5; stats.dmg *= 0.7; stats.rate *= 0.9; 
        stats.alchemistMode = true; stats.neurotoxin = false; stats.pandemic = false;
      }},
    { id: 'Trickster', icon: 'üÉè', title: '„Éà„É™„ÉÉ„ÇØ„Çπ„Çø„Éº', desc: 'ÈÅãÂê¶Â§©Ë≥¶: Âºæ„ÅÆÊÄßËÉΩ„ÅåÊØéÂõû„É©„É≥„ÉÄ„É†„Å´Â§âÂåñ„Åô„Çã„ÄÇ', 
      color: '#ff00ff', func: ()=>{
        stats.rate = 5; stats.dmg = 18; stats.tricksterMode = true; 
        stats.slotMachine = false; stats.joker = false;
      }}
];

// --- Á¨¨2Ê¨°ÈÄ≤Âåñ (Level 40) ---
// parent: „Åì„ÅÆ„ÇØ„É©„Çπ„Åã„ÇâÈÄ≤Âåñ„Åß„Åç„ÇãÔºàË¶™„ÇØ„É©„ÇπIDÔºâ
const SECOND_EVO_DATA = [
    // Samurai
    { parent: 'Samurai', id: 'Ashura', icon: 'üëπ', title: 'Èòø‰øÆÁæÖ', desc: '‰π±Ëàû: ÊîªÊíÉÈÄüÂ∫¶„ÅåÊ•µÈôê„Åæ„Åß‰∏äÊòá„Åó„ÄÅÁõÆ„Å´„ÇÇÊ≠¢„Åæ„Çâ„Å¨ÈÄ£Á∂öÊñ¨„Çä„ÇíÁπ∞„ÇäÂá∫„Åô„ÄÇ', 
      color: '#ff0033', func: ()=>{ stats.rate = 15; stats.dmg *= 0.8; } },
    { parent: 'Samurai', id: 'Kensei', icon: 'üåÄ', title: 'Ââ£ËÅñ', desc: 'ÁúüÁ©∫Ê≥¢: Êñ¨ÊíÉ„Å®ÂêåÊôÇ„Å´„ÄÅÈÅ†„Åè„Åæ„ÅßÈ£õ„Å∂Èã≠„ÅÑË°ùÊíÉÊ≥¢„ÇíÊîæ„Å§„ÄÇ', 
      color: '#ccccff', func: ()=>{ stats.swordWave = true; stats.dmg *= 1.5; } },

    // Tempest
    { parent: 'Tempest', id: 'Thor', icon: '‚õàÔ∏è', title: '„Éà„Éº„É´', desc: 'Èõ∑Á•û: ËêΩÈõ∑„ÅÆÂêåÊôÇÊîªÊíÉÊï∞„ÅåÂäáÁöÑ„Å´Â¢ó„Åà„ÄÅÁîªÈù¢ÂÖ®‰Ωì„ÇíÁÑº„ÅçÊâï„ÅÜ„ÄÇ', 
      color: '#ffff00', func: ()=>{ stats.lightning += 5; stats.lightningDmgMult = 2.0; } },
    { parent: 'Tempest', id: 'PlasmaLord', icon: '‚öõÔ∏è', title: '„Éó„É©„Ç∫„Éû„É≠„Éº„Éâ', desc: 'ÁêÉÁä∂Á®≤Â¶ª: Âºæ„Åå„ÄåË∂Ö‰ΩéÈÄü„ÅßÈÄ≤„Åø„Å™„Åå„ÇâÂë®Âõ≤„ÇíÊÑüÈõª„Åï„Åõ„ÇãÁêÉ‰Ωì„Äç„Å´Â§âÂåñ„Åô„Çã„ÄÇ', 
      color: '#aa00ff', func: ()=>{ stats.bulletSpeed = 3; stats.pierce = 999; stats.dmg *= 2.0; player.size = 20; } },

    // Alchemist
    { parent: 'Alchemist', id: 'NecroToxin', icon: 'üßü', title: '„Éç„ÇØ„É≠„Éà„Ç≠„Ç∑„Ç≥„É≠„Ç∏„Çπ„Éà', desc: 'Ê≠ªËÄÖËòáÁîü: ÊØí„ÅßÂÄí„Åó„ÅüÊïµ„ÅåÈ´òÁ¢∫Áéá„ÅßÂë≥Êñπ„ÅÆ„Çæ„É≥„Éì„Å®„Åó„Å¶Ëòá„Çã„ÄÇ', 
      color: '#00ff00', func: ()=>{ stats.zombieVirus = true; } },
    { parent: 'Alchemist', id: 'MadScientist', icon: 'üí•', title: '„Éû„ÉÉ„Éâ„Çµ„Ç§„Ç®„É≥„ÉÜ„Ç£„Çπ„Éà', desc: 'ÈÄ£ÈéñÁàÜÁô∫: ÊØí„Ç¨„Çπ„ÅåÂºïÁÅ´ÊÄß„Å´„Å™„Çä„ÄÅÊîªÊíÉ„ÇíÂΩì„Å¶„Çã„Å®Â§ßÁàÜÁô∫„ÇíËµ∑„Åì„Åô„ÄÇ', 
      color: '#ff00ff', func: ()=>{ stats.chemicalBurn = true; stats.dmg *= 1.5; } },

    // Trickster
    { parent: 'Trickster', id: 'Gambler', icon: 'üé∞', title: '„ÇÆ„É£„É≥„Éñ„É©„Éº', desc: '„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà: ÊïµÊíÉÁ†¥ÊôÇ„ÅÆÁµåÈ®ìÂÄ§Áç≤ÂæóÈáè„ÅåÁ®Ä„Å´100ÂÄç„Å´„Å™„Çã„ÄÇ', 
      color: '#ffd700', func: ()=>{ stats.jackpotChance = 0.1; } },
    { parent: 'Trickster', id: 'JokerMaster', icon: 'üÉè', title: '„Ç∏„Éß„Éº„Ç´„Éº', desc: '„ÉØ„Ç§„É´„Éâ„Ç´„Éº„Éâ: ÂÖ®„ÇØ„É©„Çπ„ÅÆÊúÄÂº∑„Çπ„Ç≠„É´„Åå„É©„É≥„ÉÄ„É†„ÅßÁô∫Âãï„Åô„Çã„ÄÇ', 
      color: '#ffffff', func: ()=>{ stats.wildCard = true; } },

    // Assault
    { parent: 'Assault', id: 'ClusterStriker', icon: 'üí•', title: '„ÇØ„É©„Çπ„Çø„Éº„Éª„Çπ„Éà„É©„Ç§„Ç´„Éº', desc: 'ÁàÜÁô∫ÁâπÂåñ: ÁùÄÂºæÊôÇ„Å´„ÄåÂ≠êÁàÜÂºæ„Äç„ÅåÂë®Âõ≤„Å´È£õ„Å≥Êï£„Çä„ÄÅË™òÁàÜÈÄ£Èéñ„ÇíÂºï„ÅçËµ∑„Åì„Åô„ÄÇ', 
      color: '#ff8800', func: ()=>{ stats.clusterStriker = true; stats.dmg *= 1.2; } },
    { parent: 'Assault', id: 'BulletStorm', icon: 'üå™Ô∏è', title: '„Éê„É¨„ÉÉ„Éà„Éª„Çπ„Éà„Éº„É†', desc: 'ÂºæÂπïÁâπÂåñ: ÊîªÊíÉ‰∏≠„ÄÅÈÄ£Â∞ÑÈÄüÂ∫¶„Å®Êã°Êï£ÁØÑÂõ≤„ÅåÁÑ°Èôê„Å´‰∏äÊòá„Åô„Çã„ÄÇÁîªÈù¢„ÇíÂüã„ÇÅÂ∞Ω„Åè„ÅõÔºÅ', 
      color: '#0088ff', func: ()=>{ stats.bulletStorm = true; } },

    // Melee
    { parent: 'Melee', id: 'FlyingSwords', icon: 'üó°Ô∏è', title: 'Âæ°Ââ£', desc: 'ÈÅ†ÈöîÊñ¨ÊíÉ: ÂõûËª¢ÂàÉ„Åå„Éó„É¨„Ç§„É§„Éº„Åã„ÇâÈõ¢„Çå„ÄÅËá™Âæã„Åó„Å¶Êïµ„ÇíËøΩÂ∞æ„ÉªÂàá„ÇäÂàª„ÇÄ„ÄÇ', 
      color: '#ff0066', func: ()=>{ /* „É≠„Ç∏„ÉÉ„ÇØÂÅ¥„ÅßÂá¶ÁêÜ */ } },
    { parent: 'Melee', id: 'SunCrusher', icon: '‚òÄÔ∏è', title: '„Çµ„É≥„Éª„ÇØ„É©„ÉÉ„Ç∑„É£„Éº', desc: 'ÁÅºÁÜ±È†òÂüü: ÂÅúÊ≠¢‰∏≠„Å´„Ç®„Éç„É´„ÇÆ„ÉºÂÖÖÂ°´„ÄÇÁßªÂãïÈñãÂßãÊôÇ„Å´Ë∂ÖÂ∫ÉÁØÑÂõ≤„ÅÆÁàÜÁÜ±Ê≥¢„ÇíÊîæ„Å§„ÄÇ', 
      color: '#ffd700', func: ()=>{ stats.auraRange += 50; } },

    // Sniper
    { parent: 'Sniper', id: 'DimensionWalker', icon: 'üåå', title: '„Éá„Ç£„É°„É≥„Ç∑„Éß„É≥„Éª„Ç¶„Ç©„Éº„Ç´„Éº', desc: 'Ê¨°ÂÖÉÂπ≤Ê∏â: Âºæ„ÅåÁîªÈù¢Á´Ø„Çí„É´„Éº„Éó„Åô„ÇãÂ∫¶„ÄÅÂ∑®Â§ßÂåñ„ÅóÂ®ÅÂäõ„ÅåÂÄçÂ¢ó„Åô„Çã„ÄÇ', 
      color: '#88ff88', func: ()=>{ stats.ghostShot = true; stats.infinitePierce = true; } },
    { parent: 'Sniper', id: 'PrismShooter', icon: 'üíé', title: '„Éó„É™„Ç∫„É†„Éª„Ç∑„É•„Éº„Çø„Éº', desc: 'Âπæ‰ΩïÂ≠¶ÂèçÂ∞Ñ: Âºæ„ÅåÊïµ„ÇÑÂ£Å„Å´ÂΩì„Åü„Çã„Åü„Å≥„Å´2„Å§„Å´ÂàÜË£Ç„Åó„ÄÅ„É¨„Éº„Ç∂„ÉºÁ∂≤„ÇíÂΩ¢Êàê„Åô„Çã„ÄÇ', 
      color: '#ff00ff', func: ()=>{ stats.prismSplit = true; stats.dmg *= 0.8; } },

    // Guardian
    { parent: 'Guardian', id: 'TeslaEngineer', icon: '‚ö°', title: '„ÉÜ„Çπ„É©„Éª„Ç®„É≥„Ç∏„Éã„Ç¢', desc: 'ÈõªÊ∞óÊüµ: Ë®≠ÁΩÆ„Åó„Åü„Çø„É¨„ÉÉ„ÉàÂêåÂ£´„Åå„ÄåÈ´òÂúßÈõªÊµÅ„Äç„ÅßÊé•Á∂ö„Åï„Çå„ÄÅËß¶„Çå„ÅüÊïµ„ÇíÁÑº„ÅçÂ∞Ω„Åè„Åô„ÄÇ', 
      color: '#00ffcc', func: ()=>{ stats.teslaGrid = true; stats.sentryMax = 12; } },
    { parent: 'Guardian', id: 'EarthShaker', icon: 'ü¶ç', title: '„Ç¢„Éº„Çπ„Éª„Ç∑„Çß„Ç§„Ç´„Éº', desc: 'ÈáçÊà¶Ëªä: Â∑®Â§ßÂåñ„Åó„ÄÅÊ≠©„Åè„Å†„Åë„ÅßË∂≥ÂÖÉ„Å´Ë°ùÊíÉÊ≥¢„ÅåÁô∫Áîü„ÄÇÊïµ„ÇíÂºæ„ÅçÈ£õ„Å∞„ÅóÁ≤âÁ†ï„Åô„Çã„ÄÇ', 
      color: '#885500', func: ()=>{ stats.isEarthShaker = true; player.size = 30; player.maxHp += 1000; player.hp += 1000; stats.armor += 10; } }
];

const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
if(isMobile) {
    document.getElementById('mobile-controls').style.display = 'block';
    document.getElementById('dash-btn').style.display = 'flex';
}

let joyTouchId = null;
let joyStartX = 0, joyStartY = 0;
let joyMoveX = 0, joyMoveY = 0;
const JOY_MAX_RADIUS = 50;

const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx = null;
let lastSoundTime = {};

// ‚òÖ Sound Engine
const Sound = {
    activeEndTimes: [],
    init: () => { 
        if(!actx) {
            actx = new AudioCtx(); 
            const resumeFunc = () => {
                if(actx.state === 'suspended') actx.resume();
                window.removeEventListener('click', resumeFunc);
                window.removeEventListener('touchstart', resumeFunc);
                window.removeEventListener('keydown', resumeFunc);
            };
            window.addEventListener('click', resumeFunc);
            window.addEventListener('touchstart', resumeFunc);
            window.addEventListener('keydown', resumeFunc);
        }
    },
    update: () => {
        if(!actx) return;
        const now = actx.currentTime;
        Sound.activeEndTimes = Sound.activeEndTimes.filter(t => t > now);
    },
    play: (type, pitch = 1.0) => {
        if(!actx) Sound.init();
        if(!actx) return;
        if(actx.state === 'suspended') actx.resume().catch(()=>{});
        if(Sound.activeEndTimes.length >= MAX_SOUND_CONCURRENT) return;

        const now = actx.currentTime;
        if(lastSoundTime[type] && now - lastSoundTime[type] < 0.05) return;
        lastSoundTime[type] = now;

        const osc = actx.createOscillator();
        const gain = actx.createGain();
        osc.connect(gain);
        gain.connect(actx.destination);

        if(level >= 100) pitch *= 0.8;

        let duration = 0.1;
        if(type === 'shoot') {
            duration = 0.1; osc.frequency.setValueAtTime(300 * pitch, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
        } else if(type === 'missile') { 
            duration = 0.3; osc.type='square'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(400, now+0.2); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
        } else if(type === 'hit') {
            duration = 0.05; osc.type='square'; osc.frequency.setValueAtTime(100 * pitch, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.05);
        } else if(type === 'dash') {
            duration = 0.2; osc.type='triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(200, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
        } else if(type === 'laser') {
            duration = 0.5; osc.type='sawtooth'; osc.frequency.setValueAtTime(800, now); osc.frequency.linearRampToValueAtTime(200, now+0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.5);
        } else if(type === 'freeze') {
            duration = 0.3; osc.type='sine'; osc.frequency.setValueAtTime(2000, now); osc.frequency.linearRampToValueAtTime(1000, now+0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
        } else if(type === 'explode') {
            duration = 0.2; osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
        } else if(type === 'levelup') {
            duration = 0.6; osc.type='triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now+0.1); osc.frequency.setValueAtTime(659, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.6);
        } else if(type === 'milestone') {
            duration = 0.8; osc.type='sawtooth'; osc.frequency.setValueAtTime(110, now); osc.frequency.linearRampToValueAtTime(440, now+0.8); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.8);
        } else if(type === 'alert') {
            duration = 0.5; osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(150, now+0.5); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.5);
        } else if(type === 'exp') {
            duration = 0.1; osc.type='sine'; let freq = 1000 * pitch; osc.frequency.setValueAtTime(freq, now); osc.frequency.linearRampToValueAtTime(freq + 500, now+0.05); gain.gain.setValueAtTime(0.03, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
        } else if(type === 'bounce') {
            duration = 0.1; osc.type='triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(300, now+0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
        } else if(type === 'bash') {
            duration = 0.2; osc.type='square'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
        } else if(type === 'lightning') {
            duration = 0.2; osc.type='sawtooth'; osc.frequency.setValueAtTime(800, now); osc.frequency.linearRampToValueAtTime(100, now+0.2); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
        } else if(type === 'spark') {
            duration = 0.15; osc.type='sawtooth'; osc.frequency.setValueAtTime(2000, now); osc.frequency.linearRampToValueAtTime(500, now+0.15); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.15);
        } else if(type === 'powerup') {
            duration = 0.5; osc.type='sine'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now+0.25); osc.frequency.linearRampToValueAtTime(1760, now+0.5); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.5);
        } else if(type === 'bomb') {
            duration = 1.0; osc.type='sawtooth'; osc.frequency.setValueAtTime(50, now); osc.frequency.linearRampToValueAtTime(20, now+1.0); gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now+1.0);
        }
        osc.start(now); osc.stop(now + duration);
        Sound.activeEndTimes.push(now + duration + 0.05);
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let scaleFactor = 1;
function resizeCanvas() {
    let winW = window.innerWidth;
    let winH = window.innerHeight;
    const isPortrait = winH > winW;
    const targetWidth = isPortrait ? 900 : 1600;
    scaleFactor = winW < targetWidth ? targetWidth / winW : 1;
    canvas.width = winW * scaleFactor;
    canvas.height = winH * scaleFactor;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas(); 

let lastTime = 0;
let startTime = 0;
let gameActive = false;
let score = 0;
let level = 1;
let exp = 0;
let nextExp = 50; 
let screenShake = 0;
let bossCycleCounter = 0; 
let bossWarningTimer = 0;
let bossWarningActive = false; 
let earthquakeTimer = 0;
let electroFenceTimer = 0; 
let singularityMode = false;

// Guardian Sentry
let sentries = [];
let sentryTimer = 0;

// Items
let items = [];

let player = {
    x: canvas.width/2, y: canvas.height/2, size: 15,
    hp: 100, maxHp: 100,
    class: 'Novice', subClass: null, color: '#00ffff',
    invincible: 0,
    dashCd: 0, maxDashCd: 120,
    slamCd: 0,
    laserCd: 0, freezeCd: 0,
    // Unique states
    sunCharge: 0, // Crusader
    isMoving: false
};

let stats = {
    critChance: 0.05, // ‰ºöÂøÉÁéáÔºàÂàùÊúüÂÄ§5%Ôºâ
    dodge: 0,         // ÂõûÈÅøÁéá
    areaScale: 1.0,   // ÊîªÊíÉ„Çµ„Ç§„Ç∫ÂÄçÁéá
    duration: 1.0,    // ÊåÅÁ∂öÊôÇÈñìÂÄçÁéáÔºàÊØí„ÇÑË®≠ÁΩÆÁâ©Áî®Ôºâ
    knockback: 0,     // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÂäõ
    critMult: 2.0,   // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´ÊôÇ„ÅÆ„ÉÄ„É°„Éº„Ç∏ÂÄçÁéáÔºàÊúÄÂàù„ÅØ2ÂÄçÔºâ
    hpDamage: 0,     // Êïµ„ÅÆÊúÄÂ§ßHP„ÅÆ‰Ωï%„ÇíÂâä„Çã„ÅãÔºàÊúÄÂàù„ÅØ0%Ôºâ
    lowHpDmg: false,
    spd: 7, dmg: 15, rate: 25, multi: 1, 
    bulletSpeed: 16, pierce: 0, 
    aura: false, auraRange: 0,
    regen: 1, magnet: 150, 
    homing: 0, lightning: 0, poison: 0, spinBlade: 0, chakram: 0,
    missile: 0, drones: 0, auraScale: 1,
    lifesteal: 0, infinitePierce: false,
    missileBlast: 1, gravityAura: false, spreadShot: false,
    napalm: false, spikeArmor: false, dashNova: false, 
    splitShot: false, giantSlayer: false,
    armor: 0, 
    knockback: 0, shrapnel: false, 
    
    // Guardian Skills
    sentrySystem: false, siegeMode: false, reactiveArmor: false, 
    nanoRepair: false, clusterMine: false, forceField: false,
    forceFieldCd: 0, isStationary: false,
    sentryMax: 5, sentryRate: 1.0,
    
    // Forbidden Skills
    shotExplode: false, shotBounce: false, doubleShot: false, 
    missileChance: 0, infiniteMag: false, gatling: false,
    titan: false, blackHole: false, bladeStorm: false, 
    earthquake: false, spikeReflect: false, bloodLust: false,
    railgun: false, execute: false, deadeye: false, 
    electroFence: false, chainBurst: false, orbital: false,
    omegaLaser: false, absoluteZero: false, necromancer: false,

    // Sub Class Specifics
    ghostShot: false, // Dimension Walker
    prismSplit: false, // Prism Shooter
    isEarthShaker: false,
    teslaGrid: false,
    bulletStorm: false, // Assault B
    clusterStriker: false // Assault A
};

let bullets = [];
let enemyBullets = [];
let enemies = [];
let particles = [];
let expOrbs = [];
let texts = [];
let orbitals = [];
let drones = []; 
let gasClouds = [];
let spikeBits = [];
// Flying Swords
let flyingSwords = [];

// --- Input Handling (PC & Mobile Improved) ---
const keys = {};

window.addEventListener('keydown', e => { keys[e.key] = true; if(e.code === 'Space') dash(); });
window.addEventListener('keyup', e => keys[e.key] = false);

// „ÉÄ„ÉÉ„Ç∑„É•„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
const dashBtn = document.getElementById('dash-btn');
if(dashBtn) {
    dashBtn.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        dash(); 
    }, {passive: false});
}

// „Éò„É´„Éë„ÉºÔºö„Çø„ÉÉ„ÉÅ„Åó„ÅüÂ†¥ÊâÄ„Åå„Éú„Çø„É≥„ÇÑ„Ç´„Éº„Éâ„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
function isInteractive(target) {
    // „Éú„Çø„É≥„ÄÅ„Åæ„Åü„ÅØ„Ç´„Éº„ÉâÔºà„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÈÅ∏ÊäûËÇ¢Ôºâ„ÅÆ‰∏ä„Å™„Çâ true
    return target.tagName === 'BUTTON' || target.closest('.card') || target.id === 'dash-btn';
}

// „Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÂá¶ÁêÜÔºà‰øÆÊ≠£Áâà v2Ôºâ
const handleTouchStart = (e) => {
    // „Éú„Çø„É≥„ÇÑ„Ç´„Éº„Éâ„ÇíËß¶„Å£„ÅüÊôÇ„ÅØ preventDefault „Åó„Å™„ÅÑÔºà„ÇØ„É™„ÉÉ„ÇØ„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
    if(!isInteractive(e.target)) {
        if(e.cancelable) e.preventDefault();
    }

    for(let i=0; i<e.changedTouches.length; i++) {
        let t = e.changedTouches[i];
        
        // ÁîªÈù¢Â∑¶ÂçäÂàÜ„ÇíËß¶„Å£„Åü„Çâ„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÈñãÂßã
        // „Åü„Å†„Åó„Çπ„Çø„Éº„ÉàÁîªÈù¢„Å™„Å©„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÊôÇ„ÅØ„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÇíÂèçÂøú„Åï„Åõ„Å™„ÅÑ
        if(gameActive && t.clientX < window.innerWidth / 2 && joyTouchId === null) {
            joyTouchId = t.identifier;
            joyStartX = t.clientX;
            joyStartY = t.clientY;
            
            let zone = document.getElementById('joystick-zone');
            zone.style.display = 'block';
            zone.style.left = joyStartX + 'px';
            zone.style.top = joyStartY + 'px';
            
            let knob = document.getElementById('joystick-knob');
            knob.style.transform = `translate(-50%, -50%)`;
            
            updateJoystick(t.clientX, t.clientY);
        }
    }
};

const handleTouchMove = (e) => {
    // ÁßªÂãï‰∏≠„ÅØÂü∫Êú¨preventDefault„Åó„Åü„ÅÑ„Åå„ÄÅ„Éú„Çø„É≥‰∏ä„Å™„ÇâË®±ÂèØÔºà„Çπ„ÇØ„É≠„Éº„É´„ÅØÈò≤„Åé„Åü„ÅÑ„ÅÆ„ÅßÊù°‰ª∂ÂàÜÂ≤êÔºâ
    if(e.cancelable) e.preventDefault();
    
    for(let i=0; i<e.changedTouches.length; i++) {
        let t = e.changedTouches[i];
        if(t.identifier === joyTouchId) {
            updateJoystick(t.clientX, t.clientY);
        }
    }
};

const handleTouchEnd = (e) => {
    // ‚òÖ„Åì„Åì„Åå‰øÆÊ≠£ÁÇπÔºö„Éú„Çø„É≥„ÅÆ‰∏ä„ÅßÊåá„ÇíÈõ¢„Åó„ÅüÊôÇ„ÅØ preventDefault „Åó„Å™„ÅÑÔºÅ
    if(!isInteractive(e.target)) {
        if(e.cancelable) e.preventDefault();
    }
    
    for(let i=0; i<e.changedTouches.length; i++) {
        let t = e.changedTouches[i];
        if(t.identifier === joyTouchId) {
            resetJoystick();
        }
    }
};

const handleTouchCancel = (e) => {
    if(e.cancelable) e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        let t = e.changedTouches[i];
        if(t.identifier === joyTouchId) {
            resetJoystick();
        }
    }
};

function resetJoystick() {
    joyTouchId = null;
    joyMoveX = 0; joyMoveY = 0;
    let zone = document.getElementById('joystick-zone');
    if(zone) zone.style.display = 'none';
    let knob = document.getElementById('joystick-knob');
    if(knob) knob.style.transform = `translate(-50%, -50%)`;
}

window.addEventListener('touchstart', handleTouchStart, {passive: false});
window.addEventListener('touchmove', handleTouchMove, {passive: false});
window.addEventListener('touchend', handleTouchEnd, {passive: false});
window.addEventListener('touchcancel', handleTouchCancel, {passive: false});

function updateJoystick(cx, cy) {
    let dx = cx - joyStartX;
    let dy = cy - joyStartY;
    let dist = Math.hypot(dx, dy);
    
    if(dist > JOY_MAX_RADIUS) {
        let ratio = JOY_MAX_RADIUS / dist;
        dx *= ratio;
        dy *= ratio;
    }
    
    joyMoveX = dx / JOY_MAX_RADIUS;
    joyMoveY = dy / JOY_MAX_RADIUS;
    
    let knob = document.getElementById('joystick-knob');
    if(knob) knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
}


function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    Sound.init();
    Sound.play('levelup');
    gameActive = true;
    player.x = canvas.width/2;
    player.y = canvas.height/2;
    startTime = Date.now();
    lastTime = performance.now();
    updateSkillList();
    updateUI(); // Init UI text
    requestAnimationFrame(loop);
}

function loop(timestamp) {
    if(!gameActive) return;
    const dt = timestamp - lastTime;
    lastTime = timestamp;
    let timeScale = dt / (1000 / 60);
    if(timeScale > 4) timeScale = 4;
    
    Sound.update();

    update(timeScale);
    draw();
    requestAnimationFrame(loop);
}

function update(ts) {
    let gameTimeSec = (Date.now() - startTime) / 1000;
    
    if(level >= 100 && !singularityMode) {
        singularityMode = true;
        document.body.classList.add('singularity-mode');
        Sound.play('milestone');
    }

    let m = Math.floor(gameTimeSec/60);
    let s = Math.floor(gameTimeSec%60);
    document.getElementById('disp-time').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

    if(player.dashCd > 0) player.dashCd -= ts;
    if(player.invincible > 0) player.invincible -= ts;
    if(player.slamCd > 0) player.slamCd -= ts;
    if(screenShake > 0) screenShake *= 0.9;
    
    // Guardian Skills Update
    if(stats.sentrySystem) {
        let sentrySpawnRate = 600 / stats.sentryRate; 
        sentryTimer -= ts;
        if(sentryTimer <= 0) {
            spawnSentry();
            sentryTimer = sentrySpawnRate; 
        }
        sentries.forEach(s => {
            s.cooldown -= ts;
            if(s.cooldown <= 0) {
                let target = null;
                let minDSq = 400 * 400; 
                enemies.forEach(e => {
                    if(e.dead) return;
                    let dSq = (e.x - s.x)**2 + (e.y - s.y)**2;
                    if(dSq < minDSq) { minDSq = dSq; target = e; }
                });
                if(target) {
                    let ang = Math.atan2(target.y - s.y, target.x - s.x);
                    let fireDelay = Math.max(5, stats.rate * (1/stats.sentryRate));
                    bullets.push({type:'normal', x:s.x, y:s.y, vx:Math.cos(ang)*stats.bulletSpeed, vy:Math.sin(ang)*stats.bulletSpeed, size:6, color:'#0f0', hit:[], pierce:stats.pierce});
                    Sound.play('shoot', 1.5);
                    s.cooldown = fireDelay;
                }
            }
        });
        
        if(stats.teslaGrid && sentries.length >= 2) {
            for(let i=0; i<sentries.length; i++) {
                let s1 = sentries[i];
                let s2 = sentries[(i+1)%sentries.length];
                enemies.forEach(e => {
                    if(e.dead) return;
                    let dist = pointToLineDistance(e.x, e.y, s1.x, s1.y, s2.x, s2.y);
                    if(dist < e.size + 5) {
                        damageEnemy(e, stats.dmg * 2.0);
                        if(Math.random()<0.2*ts) createParticles(e.x, e.y, '#0ff', 2, 2);
                    }
                });
            }
        }
    }

    if(stats.forceField) {
        if(stats.forceFieldCd > 0) stats.forceFieldCd -= ts;
    }

    if(stats.nanoRepair && player.hp < player.maxHp * 0.3) {
        player.hp = Math.min(player.maxHp, player.hp + (50/60)*ts);
    }

    if(stats.slotMachine) {
        if(typeof player.slotTimer === 'undefined') player.slotTimer = 300;
        player.slotTimer -= ts;
        if(player.slotTimer <= 0) {
            player.slotTimer = 300; 
            Sound.play('powerup');
            let luck = Math.random();
            if(luck < 0.3) {
                stats.rate = 2; 
                if(texts.length < MAX_TEXTS) texts.push({x:player.x, y:player.y-20, str:"FEVER!!", life:60, color:'#ff0'});
            } else if(luck < 0.6) {
                stats.bulletSpeed = 40; 
                texts.push({x:player.x, y:player.y-20, str:"SPEED UP!", life:60, color:'#0ff'});
            } else if(luck < 0.8) {
                player.size = 50; 
                texts.push({x:player.x, y:player.y-20, str:"BIG MODE", life:60, color:'#f00'});
            } else {
                stats.multi = 10; 
                texts.push({x:player.x, y:player.y-20, str:"MULTI!!", life:60, color:'#f0f'});
            }
            setTimeout(()=>{ 
                stats.rate = 5; stats.bulletSpeed = 16; player.size = 15; stats.multi = 1; 
            }, 3000);
        }
    }

    if(stats.omegaLaser) {
        player.laserCd -= ts;
        if(player.laserCd <= 0) { fireOmegaLaser(); player.laserCd = 180; }
    }
    
    if(stats.tempestMode) {
        if(Math.random() < 0.1 * ts) { 
            let targets = enemies.filter(e => !e.dead && Math.hypot(e.x-player.x, e.y-player.y) < 500);
            if(targets.length > 0) {
                let target = targets[Math.floor(Math.random() * targets.length)];
                triggerLightning(target, stats.lightning);
            }
        }
    }

    if(stats.absoluteZero) {
        enemies.forEach(e => {
            // ÁØÑÂõ≤„Çí 250 ‚Üí 180 „Å´Â∞ë„ÅóÁ∏ÆÂ∞èÔºàËøë„Å•„Åã„Å™„ÅÑ„Å®ÂäπÊûú„ÅåÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
            if(!e.dead && Math.hypot(e.x-player.x, e.y-player.y) < 200) {
                // „ÄêÂ§âÊõ¥ÁÇπ„Äë
                // ÊØéÂõû e.frozen=5 „Å´„Åô„Çã„Å®ÂÆåÂÖ®ÂÅúÊ≠¢„Åô„Çã„Åü„ÇÅ„ÄÅ
                // „Äå50%„ÅÆÁ¢∫Áéá„Åß‰∏ÄÁû¨Ê≠¢„ÇÅ„Çã„Äç„Åì„Å®„Åß„ÄÅ„Ç´„ÇØ„Ç´„ÇØÂãï„Åç„Å™„Åå„ÇâËøë„Å•„ÅÑ„Å¶„Åè„Çã„ÄåÊ∏õÈÄü„ÄçÂäπÊûú„Å´„Åó„Åæ„Åô„ÄÇ
                if(Math.random() < 0.5) {
                    e.frozen = 2; 
                }
            }
        });
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊºîÂá∫„ÅØ„Åù„ÅÆ„Åæ„Åæ
        if(Math.random() < 0.2*ts && particles.length < MAX_PARTICLES) createParticles(player.x + (Math.random()-0.5)*500, player.y + (Math.random()-0.5)*500, '#88ffff', 1, 1);
    }
    if(stats.earthquake) {
        earthquakeTimer -= ts;
        if(earthquakeTimer <= 0) {
            earthquakeTimer = 120; 
            screenShake = 15; Sound.play('bash');
            enemies.forEach(e => { if(!e.dead) damageEnemy(e, stats.dmg * 2); });
            particles.push({type:'shockwave', x:player.x, y:player.y, size:400, life:30, color:'#f80'});
        }
    }
    if(stats.electroFence) {
        electroFenceTimer -= ts;
        if(electroFenceTimer <= 0) {
            electroFenceTimer = 60; 
            let r = 150;
            Sound.play('spark');
            particles.push({type:'shockwave', x:player.x, y:player.y, size:r, life:20, color:'#88ffff'});
            enemies.forEach(e => {
                if(!e.dead && Math.hypot(e.x-player.x, e.y-player.y) < r + e.size) {
                    damageEnemy(e, stats.dmg);
                    e.frozen = 30; 
                    let ang = Math.atan2(e.y-player.y, e.x-player.x);
                    e.x += Math.cos(ang) * 30; e.y += Math.sin(ang) * 30; 
                    createLightningEffect(player.x, player.y, e.x, e.y);
                }
            });
        }
    }

    if(stats.orbital && Math.random() < 0.05 * ts) {
        let t = enemies[Math.floor(Math.random()*enemies.length)];
        if(t && !t.dead) {
            createParticles(t.x, t.y, '#f0f', 10, 3);
            damageEnemy(t, stats.dmg * 5);
            Sound.play('laser');
            particles.push({type:'shockwave', x:t.x, y:t.y, size:50, life:10, color:'#f0f'});
        }
    }

    if(Math.random() < (1/60) * ts && player.hp < player.maxHp) {
        player.hp = Math.min(player.maxHp, player.hp + stats.regen);
        updateUI();
    }

    let dx = 0, dy = 0;
    if(keys['w'] || keys['ArrowUp']) dy = -1;
    if(keys['s'] || keys['ArrowDown']) dy = 1;
    if(keys['a'] || keys['ArrowLeft']) dx = -1;
    if(keys['d'] || keys['ArrowRight']) dx = 1;

    if(joyTouchId !== null) { dx = joyMoveX; dy = joyMoveY; }

    if(dx!==0 || dy!==0) {
        let len = Math.hypot(dx, dy);
        if(len > 1) { dx/=len; dy/=len; }
        player.x += dx * stats.spd * ts;
        player.y += dy * stats.spd * ts;
        stats.isStationary = false;
        player.isMoving = true;
    } else {
        stats.isStationary = true;
        player.isMoving = false;
    }

    player.x = Math.max(15, Math.min(canvas.width-15, player.x));
    player.y = Math.max(15, Math.min(canvas.height-15, player.y));

    if(stats.isEarthShaker && player.isMoving) {
        if(Math.floor(Date.now() / 200) % 2 === 0) { 
            screenShake = 2;
            enemies.forEach(e => {
                if(!e.dead && Math.hypot(e.x-player.x, e.y-player.y) < player.size + 40) {
                    damageEnemy(e, stats.dmg * 0.5); 
                    let pushAng = Math.atan2(e.y - player.y, e.x - player.x);
                    e.x += Math.cos(pushAng) * 10 * ts; e.y += Math.sin(pushAng) * 10 * ts; 
                }
            });
        }
    }

    // --- Skills ---
    if(player.class === 'Melee' && (stats.multi > 0 || stats.bladeStorm)) {
        let count = stats.multi + (stats.bladeStorm ? 4 : 0);
        if(player.subClass === 'FlyingSwords') {
             if(flyingSwords.length !== count) {
                 flyingSwords = [];
                 for(let i=0; i<count; i++) flyingSwords.push({x:player.x, y:player.y, target:null, cooldown:0});
             }
             flyingSwords.forEach(sw => {
                 if(sw.cooldown > 0) sw.cooldown -= ts;
                 if(!sw.target || sw.target.dead || Math.hypot(sw.target.x-player.x, sw.target.y-player.y) > 400) {
                     sw.target = null;
                     let minD = 350;
                     enemies.forEach(e => {
                         if(e.dead) return;
                         let d = Math.hypot(e.x-player.x, e.y-player.y);
                         if(d < minD) { minD=d; sw.target=e; }
                     });
                 }
                 let tx, ty;
                 if(sw.target) {
                     tx = sw.target.x; ty = sw.target.y;
                 } else {
                     let angle = Date.now() * 0.002 + (flyingSwords.indexOf(sw) * (Math.PI*2/count));
                     tx = player.x + Math.cos(angle) * 80;
                     ty = player.y + Math.sin(angle) * 80;
                 }
                 sw.x += (tx - sw.x) * 0.15 * ts;
                 sw.y += (ty - sw.y) * 0.15 * ts;
                 enemies.forEach(e => {
                     if(!e.dead && Math.hypot(e.x-sw.x, e.y-sw.y) < 15 && sw.cooldown <= 0) {
                         damageEnemy(e, stats.dmg * 0.8);
                         createParticles(e.x, e.y, '#f0a', 1, 1);
                         sw.cooldown = 15; 
                     }
                 });
             });
        } else {
            if(spikeBits.length !== count) {
                spikeBits = []; for(let i=0; i<count; i++) spikeBits.push({angle:0});
            }
            let rotSpd = 0.1 * ts;
            spikeBits.forEach((bit, i) => {
                bit.angle += rotSpd;
                let currentAngle = bit.angle + (Math.PI*2/count)*i;
                let radius = 25 + player.size/2 + (stats.titan ? 20 : 0);
                if(stats.isColossus) radius += 20;
                bit.x = player.x + Math.cos(currentAngle) * radius;
                bit.y = player.y + Math.sin(currentAngle) * radius;
                enemies.forEach(e => {
                    if(!e.dead && Math.hypot(e.x-bit.x, e.y-bit.y) < 15 + e.size) {
                        if(Math.random() < 0.1 * ts) damageEnemy(e, stats.dmg * 0.5);
                    }
                });
            });
        }
    }

    if(stats.missile > 0) {
        // „Çø„Ç§„Éû„ÉºÂ§âÊï∞„Åå„Å™„Åë„Çå„Å∞ÂàùÊúüÂåñ
        if(typeof player.missileCd === 'undefined') player.missileCd = 0;
        
        player.missileCd -= ts;
        if(player.missileCd <= 0) {
            fireMissile();
            // „É¨„Éô„É´„ÅåÈ´ò„ÅÑ„Åª„Å©ÈñìÈöî„ÅåÁü≠„Åè„Å™„ÇãË®àÁÆóÂºè
            let missileInterval = Math.max(10, 60 - stats.missile * 5);
            player.missileCd = missileInterval;
        }
    }

    if(drones.length < stats.drones) {
        drones.push({ x: player.x, y: player.y, angle: Math.random()*Math.PI*2, state: 'orbit', target: null, timer: 0 });
    }
    let droneSpeedMult = stats.drones > 2 ? 1.5 : 1.0; 
    
    drones.forEach(d => {
        if(d.state === 'orbit') {
            d.angle += 0.05 * ts * droneSpeedMult;
            let ox = player.x + Math.cos(d.angle) * 80;
            let oy = player.y + Math.sin(d.angle) * 80;
            d.x += (ox - d.x) * 0.1 * ts; d.y += (oy - d.y) * 0.1 * ts;
            let minD = 350;
            enemies.forEach(e => {
                if(e.dead) return;
                let dist = Math.hypot(e.x - player.x, e.y - player.y);
                if(dist < minD) { minD = dist; d.target = e; d.state = 'attack'; }
            });
        } else if(d.state === 'attack') {
            if(!d.target || d.target.dead) { d.state = 'return'; return; }
            let ang = Math.atan2(d.target.y - d.y, d.target.x - d.x);
            d.x += Math.cos(ang) * 12 * ts * droneSpeedMult; d.y += Math.sin(ang) * 12 * ts * droneSpeedMult;
            if(Math.hypot(d.x - d.target.x, d.y - d.target.y) < 20) {
                damageEnemy(d.target, stats.dmg * 2);
                if(stats.lightning > 0) triggerLightning(d.target, stats.lightning);
                if(particles.length < MAX_PARTICLES) createParticles(d.x, d.y, '#ff0', 5, 2);
                d.state = 'return'; d.timer = 30 / droneSpeedMult; 
            }
        } else if(d.state === 'return') {
            d.timer -= ts;
            if(d.timer <= 0) {
                let ox = player.x + Math.cos(d.angle) * 80;
                let oy = player.y + Math.sin(d.angle) * 80;
                let ang = Math.atan2(oy - d.y, ox - d.x);
                d.x += Math.cos(ang) * 15 * ts; d.y += Math.sin(ang) * 15 * ts;
                if(Math.hypot(ox - d.x, oy - d.y) < 20) d.state = 'orbit';
            }
        }
    });

    if(stats.doppelganger) {
        if(!player.clone) player.clone = {x:player.x, y:player.y};
        let lerp = 0.1;
        let targetX = player.x - (player.isMoving ? Math.sign(player.x - player.clone.x)*40 : 40);
        player.clone.x += (targetX - player.clone.x) * lerp;
        player.clone.y += (player.y - player.clone.y) * lerp;
    }

    // ‚ñº‚ñº‚ñº „Ç¢„É´„Ç±„Éü„Çπ„Éà‰øÆÊ≠£Ôºö„Éû„É´„ÉÅ„Ç∑„Éß„ÉÉ„Éà‰æùÂ≠òÔºÜ„É©„É≥„ÉÄ„É†Êã°Êï£ ‚ñº‚ñº‚ñº
    if(stats.poison > 0 && Math.random() < (1/30)*ts) {
        // Áô∫Â∞ÑÊï∞(multi)„Å´Âøú„Åò„Å¶„ÄÅ‰∏ÄÂ∫¶„Å´Êíí„ÅèÊØí„ÅÆÊï∞„ÅåÂ¢ó„Åà„ÇãÔºàÂàùÊúüÂÄ§1Ôºâ
        let spawnCount = Math.max(1, Math.floor(stats.multi));
        
        // Ëøë„Åè„ÅÆÊïµ„ÇíÊ§úÁ¥¢ÔºàËøë„Åô„Åé„ÅöÈÅ†„Åô„Åé„Å™„ÅÑÁØÑÂõ≤Ôºö500px‰ª•ÂÜÖÔºâ
        let targets = enemies.filter(e => !e.dead && Math.hypot(e.x - player.x, e.y - player.y) < 500);
        
        for(let k=0; k<spawnCount; k++) {
            // „Çø„Éº„Ç≤„ÉÉ„Éà„Åå„ÅÑ„Å™„Åë„Çå„Å∞„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ„Å´Êíí„Åè(ÂàùÂõû„ÅÆ„Åø)
            if(targets.length === 0) {
                if(k===0) {
                    gasClouds.push({ 
                        x: player.x, y: player.y, 
                        r: (30 + (stats.poison * 10)) * (stats.areaScale || 1.0), 
                        life: (180 + (stats.poison * 30)) * (stats.duration || 1.0), 
                        dmg: stats.dmg * (0.2 + stats.poison * 0.1),
                        tick: 0 
                    });
                }
                break;
            }

            // „É©„É≥„ÉÄ„É†„Å´„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÈÅ∏„Çì„ÅßÊØí„ÇíÁô∫Áîü„Åï„Åõ„ÇãÔºà„Å∞„ÇâÊíí„ÅçÔºâ
            let idx = Math.floor(Math.random() * targets.length);
            let t = targets[idx];

            gasClouds.push({ 
                x: t.x, y: t.y, 
                r: (30 + (stats.poison * 10)) * (stats.areaScale || 1.0), 
                life: (180 + (stats.poison * 30)) * (stats.duration || 1.0), 
                dmg: stats.dmg * (0.2 + stats.poison * 0.1),
                tick: 0 
            });

            // Âêå„ÅòÊïµ„Å´Èáç„Å™„Çä„Åô„Åé„Å™„ÅÑ„Çà„ÅÜ„ÄÅ„É™„Çπ„Éà„Åã„ÇâÈô§Â§ñ„Åó„Å¶Êï£„Çâ„Åô
            targets.splice(idx, 1);
        }
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁµÇ„Çè„Çä ‚ñ≤‚ñ≤‚ñ≤

    // 2. ÊØí„ÅÆ„ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜÔºàÁ¢∫Áéá„Åß„ÅØ„Å™„Åè‰∏ÄÂÆöÊôÇÈñì„Åî„Å®„Å´Á¢∫ÂÆö„Éí„ÉÉ„Éà„Åï„Åõ„ÇãÔºâ
    for(let i=gasClouds.length-1; i>=0; i--) {
        let g = gasClouds[i]; 
        g.life -= ts;
        
        if(typeof g.tick === 'undefined') g.tick = 0;
        g.tick -= ts;
        
        // Á¥Ñ0.25Áßí(15„Éï„É¨„Éº„É†)„Åî„Å®„Å´Âà§ÂÆö
        if(g.tick <= 0) {
            g.tick = 15; 
            enemies.forEach(e => { 
                if(!e.dead && Math.hypot(e.x - g.x, e.y - g.y) < g.r + e.size) {
                    damageEnemy(e, g.dmg);
                    if(Math.random() < 0.3) createParticles(e.x, e.y, '#aa00ff', 1, 2);
                } 
            }); 
        }
        
        if(g.life <= 0) gasClouds.splice(i, 1);
    }

    if(stats.spinBlade > 0) {
        let orbitalSpeed = (Date.now() / 1000) * 2;
        if(orbitals.length !== stats.spinBlade) { orbitals = []; for(let i=0; i<stats.spinBlade; i++) orbitals.push({}); }
        orbitals.forEach((orb, i) => {
            let angle = orbitalSpeed + (Math.PI * 2 / stats.spinBlade) * i;
            orb.x = player.x + Math.cos(angle) * 110; orb.y = player.y + Math.sin(angle) * 110;
            enemies.forEach(e => { 
                if(!e.dead && Math.hypot(e.x-orb.x, e.y-orb.y) < 20 + e.size && Math.random() < 0.12 * ts) damageEnemy(e, stats.dmg * 1.5); 
            });
        });
    }

    // --- Ê§úÁ¥¢Áî®: if(stats.aura) ---
    if(stats.aura) {
        // ‚ñº‚ñº‚ñº ‰øÆÊ≠£: areaScale (ÊîªÊíÉÁØÑÂõ≤„Ç¢„ÉÉ„Éó) „Çí„Ç™„Éº„É©ÂçäÂæÑ„Å´ÈÅ©Áî® ‚ñº‚ñº‚ñº
        let r = stats.auraRange * stats.auraScale * stats.areaScale;
        let auraRate = 0.1;
        if(player.class === 'Melee' && stats.homing > 0) auraRate += (stats.homing * 0.05);
        
        // ‚òÖ SunCrusher„ÅÆÂá¶ÁêÜÔºà„Åù„ÅÆ„Åæ„ÅæÔºâ
        if(player.subClass === 'SunCrusher') {
            if(player.isMoving) {
                if(player.sunCharge > 0) {
                    player.sunCharge -= ts * 5; 
                    r += player.sunCharge * 2; 
                    auraRate = 0.5; 
                    if(Math.random() < 0.3) createParticles(player.x+(Math.random()-0.5)*r, player.y+(Math.random()-0.5)*r, '#fa0', 1, 3);
                }
            } else {
                player.sunCharge = Math.min(100, player.sunCharge + ts);
                r = 10; 
                if(Math.random()<0.1) createParticles(player.x, player.y, '#fa0', 1, 1);
            }
        }

        enemies.forEach(e => { 
            if(e.dead) return;
            let dist = Math.hypot(e.x-player.x, e.y-player.y);
            if(dist < r + e.size) {
                if(Math.random() < auraRate * ts) {
                    // ‚òÖ„ÄêÂ§âÊõ¥ÁÇπ„Äë„Åì„Åì„Åã„ÇâÁÅ´Âäõ„ÇíÂº∑Âåñ
                    let d = stats.dmg;
                    
                    // „É¥„Ç°„É≥„Ç¨„Éº„Éâ/„Ç¨„Éº„Éá„Ç£„Ç¢„É≥Á≥ª„Å™„Çâ„ÄåÊúÄÂ§ßHP„Äç„Å®„ÄåÈò≤Âæ°Âäõ„Äç„ÇíÁÅ´Âäõ„Å´Â§âÊèõÔºÅ
                    if(player.class === 'Melee' || player.class === 'Guardian') {
                        let hpBonus = player.maxHp * 0.05; // ÊúÄÂ§ßHP„ÅÆ5%„ÇíÂä†ÁÆó
                        let armorBonus = stats.armor * 10; // Èò≤Âæ°Âäõ„ÅÆ10ÂÄç„ÇíÂä†ÁÆó
                        d += hpBonus + armorBonus;
                    }

                    if(player.subClass === 'SunCrusher' && player.isMoving) d *= (1 + player.sunCharge/20);
                    
                    damageEnemy(e, d);
                    // ‚òÖ„ÄêÂ§âÊõ¥ÁÇπ„Äë„Åì„Åì„Åæ„Åß

                    if(player.class === 'Melee' && stats.lightning > 0 && Math.random() < 0.3) {
                        triggerLightning(e, stats.lightning);
                    }
                }
                if(stats.gravityAura || stats.blackHole) {
                    let pull = (stats.blackHole ? 3.0 : 1.0) * ts; 
                    e.x += (player.x - e.x) / dist * pull;
                    e.y += (player.y - e.y) / dist * pull;
                    e.x -= Math.cos(Math.atan2(player.y-e.y, player.x-e.x)) * (e.speed*0.5) * ts; 
                    e.y -= Math.sin(Math.atan2(player.y-e.y, player.x-e.x)) * (e.speed*0.5) * ts;
                }
            } 
        });
    }

    let currentRate = stats.rate;
    if(stats.siegeMode && stats.isStationary) currentRate /= 2;
    if(stats.bulletStorm) currentRate = 3; 

    // ‚òÖ„Åì„Åì„Åã„Çâ‰øÆÊ≠£Âæå„ÅÆ„Ç≥„Éº„Éâ‚òÖ
    if(!stats.aura) {
        // „Çø„Ç§„Éû„ÉºÂ§âÊï∞„Åå„Å™„Åë„Çå„Å∞0„ÅßÂàùÊúüÂåñ
        if(typeof player.shootCd === 'undefined') player.shootCd = 0;

        // ÊôÇÈñì„ÇíÁµåÈÅé„Åï„Åõ„Çã
        player.shootCd -= ts;
        
        // „Çø„Ç§„Éû„Éº„Åå0‰ª•‰∏ã„Å´„Å™„Å£„Åü„ÇâÁô∫Â∞ÑÔºÅ
        if(player.shootCd <= 0) {
            shoot();
            
            // „Å§„ÅÑ„Åß„Å´„ÉÅ„É£„ÇØ„É©„É†„ÇÇÊäï„Åí„Çã
            if(stats.chakram > 0 && Math.random() < 0.3) fireChakram();

            // Ê¨°„ÅÆÁô∫Â∞Ñ„Åæ„Åß„ÅÆÊôÇÈñì„Çí„Çª„ÉÉ„ÉàÔºà„Åì„Çå„ÅßÁ≠âÈñìÈöî„Å´„Å™„Çä„Åæ„ÅôÔºâ
            player.shootCd = currentRate;
        }
    }

    // --- Bullets ---
    let boundary = 200; 
    for(let i=bullets.length-1; i>=0; i--) {
        let b = bullets[i];
        
        // --- ‰æç„ÅÆÊñ¨ÊíÉÂá¶ÁêÜ (Slash) - Ë∂ÖËªΩÈáèÂåñÁâà ---
        if(b.type === 'slash') {
            b.x += b.vx * ts; b.y += b.vy * ts; 
            b.life -= ts;
            
            if(b.life > 12) {
                let effectsSpawned = 0;
                const MAX_EFFECTS_PER_FRAME = 3;

                enemies.forEach(e => {
                    // ‚òÖ‰øÆÊ≠£: includes -> has
                    if(e.dead || b.hit.has(e.id)) return; 
                    
                    let range = b.size + e.size;
                    if(Math.abs(b.x - e.x) > range || Math.abs(b.y - e.y) > range) return;

                    if((b.x - e.x)**2 + (b.y - e.y)**2 < range * range) {
                        damageEnemy(e, stats.dmg * 2.0); 
                        
                        if(effectsSpawned < MAX_EFFECTS_PER_FRAME && Math.random() < 0.3) {
                            createParticles(e.x, e.y, '#fff', 3, 2); 
                            // ... („Ç®„Éï„Çß„ÇØ„ÉàÂá¶ÁêÜÁúÅÁï•) ...
                            effectsSpawned++;
                        } else if(stats.lightning > 0 && Math.random() < 0.05) {
                            triggerLightning(e, stats.lightning);
                        }

                        // ‚òÖ‰øÆÊ≠£: push -> add
                        b.hit.add(e.id);
                    }
                });
            }

            if(b.life <= 0) { bullets.splice(i, 1); }
            continue;
        }

        if(b.type === 'omega') {
            b.x += b.vx * ts; b.y += b.vy * ts; b.life -= ts;
            b.tick = (b.tick || 0) + ts;
            if(b.tick >= 5) {
                b.tick = 0;
                enemies.forEach(e => {
                    if(!e.dead && Math.abs(e.x - b.x) < b.size && Math.abs(e.y - b.y) < b.size) {
                        damageEnemy(e, stats.dmg * 5); 
                        if(particles.length < MAX_PARTICLES && Math.random() < 0.3) createParticles(e.x, e.y, '#f0f', 1, 1);
                    }
                });
            }
            if(b.life <= 0) { bullets.splice(i,1); }
            continue;
        }

        if(b.type === 'chakram') {
            b.x += b.vx * ts; b.y += b.vy * ts; b.life -= ts; 
            if(b.life <= 0) { bullets.splice(i, 1); continue; }
            if(b.x < 0 || b.x > canvas.width) { b.vx *= -1; b.x = Math.max(0, Math.min(canvas.width, b.x)); Sound.play('bounce'); }
            if(b.y < 0 || b.y > canvas.height) { b.vy *= -1; b.y = Math.max(0, Math.min(canvas.height, b.y)); Sound.play('bounce'); }
            for(let j=enemies.length-1; j>=0; j--) {
                let e = enemies[j];
                if(e.dead || b.hit.includes(e.id)) continue;
                if(Math.hypot(b.x-e.x, b.y-e.y) < b.size + e.size) {
                    damageEnemy(e, stats.dmg * 1.5);
                    if(particles.length < MAX_PARTICLES) createParticles(b.x, b.y, '#0ff', 2, 2);
                    if(b.bounceCd <= 0) {
                        let ang = Math.atan2(b.y - e.y, b.x - e.x); 
                        let spd = Math.hypot(b.vx, b.vy);
                        b.vx = Math.cos(ang) * spd; b.vy = Math.sin(ang) * spd;
                        b.bounceCd = 10;
                        Sound.play('bounce');
                    }
                }
            }
            if(b.bounceCd > 0) b.bounceCd -= ts;
            if(Math.random()<0.3 && particles.length < MAX_PARTICLES) createParticles(b.x, b.y, '#8ff', 1, 1);
            continue;
        }
        
        if(b.type !== 'missile' && stats.homing > 0) {
            let detectRange = 250 + (stats.homing * 50); 
            let target = null, minDSq = detectRange * detectRange;
            enemies.forEach(e => { 
                if(e.dead) return; 
                let dSq = (e.x-b.x)**2 + (e.y-b.y)**2;
                if(dSq < minDSq && !b.hit.includes(e.id)) { minDSq = dSq; target = e; } 
            });
            
            if(target) {
                let desiredAngle = Math.atan2(target.y - b.y, target.x - b.x);
                let currentAngle = Math.atan2(b.vy, b.vx);
                let turnSpeed = (0.05 + (stats.homing * 0.05)) * ts; 
                let diff = desiredAngle - currentAngle;
                if(diff > Math.PI) diff -= Math.PI*2; if(diff < -Math.PI) diff += Math.PI*2;
                if(Math.abs(diff) < Math.PI) {
                    currentAngle += Math.sign(diff) * Math.min(Math.abs(diff), turnSpeed);
                    let speed = Math.hypot(b.vx, b.vy);
                    b.vx = Math.cos(currentAngle) * speed; b.vy = Math.sin(currentAngle) * speed;
                }
            }
        }

        if(b.type === 'missile' || b.type === 'spirit') {
            let minD = 400, target = null;
            enemies.forEach(e => { if(e.dead) return; let d = Math.hypot(e.x-b.x, e.y-b.y); if(d < minD) { minD=d; target=e; } });
            if(target) {
                let ang = Math.atan2(target.y - b.y, target.x - b.x);
                let cur = Math.atan2(b.vy, b.vx);
                let diff = ang - cur;
                if(diff > Math.PI) diff -= Math.PI*2; if(diff < -Math.PI) diff += Math.PI*2;
                cur += Math.sign(diff) * 0.1 * ts;
                b.vx = Math.cos(cur) * b.speed; b.vy = Math.sin(cur) * b.speed;
            }
            b.x += b.vx * ts; b.y += b.vy * ts; 
            if(Math.random() < 0.5 * ts && particles.length < MAX_PARTICLES) createParticles(b.x, b.y, b.type==='spirit'?'#8f8':'#f80', 1, 2);
        } else {
            b.x += b.vx * ts; b.y += b.vy * ts;
            if(b.life !== undefined) {
                b.life -= ts;
                if(b.life <= 0) { bullets.splice(i, 1); continue; }
            }
            if(stats.ghostShot) {
                let wrapped = false;
                if(b.x < 0) { b.x = canvas.width; wrapped=true; }
                else if(b.x > canvas.width) { b.x = 0; wrapped=true; }
                if(b.y < 0) { b.y = canvas.height; wrapped=true; }
                else if(b.y > canvas.height) { b.y = 0; wrapped=true; }
                if(wrapped) {
                    b.size = Math.min(50, b.size * 1.5); 
                    b.damageMult = Math.min(8.0, (b.damageMult || 1) * 1.5);
                    if(b.life === undefined) b.life = 180; 
                    b.life -= 60; 
                    if(b.life <= 0) { bullets.splice(i, 1); continue; }
                    b.pierce = 999; 
                }
            }
        }

        if(stats.shotBounce && (b.type === 'normal')) {
            if(b.x < 0 || b.x > canvas.width) { b.vx *= -1; b.x = Math.max(0, Math.min(canvas.width, b.x)); Sound.play('bounce'); }
            if(b.y < 0 || b.y > canvas.height) { b.vy *= -1; b.y = Math.max(0, Math.min(canvas.height, b.y)); Sound.play('bounce'); }
        }
        
        if(!stats.ghostShot && (b.x < -boundary || b.x > canvas.width+boundary || b.y < -boundary || b.y > canvas.height+boundary)) { bullets.splice(i, 1); continue; }

        let hit = false;
        for(let j=enemies.length-1; j>=0; j--) {
            let e = enemies[j];
            if(e.dead || b.hit.includes(e.id)) continue;
            
            // ‚òÖÈ´òÈÄüÂåñ: Âπ≥ÊñπÊ†πË®àÁÆó„ÇíÈÅø„Åë„Çã
            let bulletHitSize = (player.class === 'Sniper' && b.type === 'normal') ? b.size + 15 : b.size;
            if(stats.titan) bulletHitSize *= 1.5;
            let collisionR = bulletHitSize + e.size;
            
            // x, y „ÅÆÂ∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ„Å†„Åë„ÅßÂºæ„Åë„ÇãÂ†¥Âêà„ÅØÂºæ„ÅèÔºàAABBÁ∞°ÊòìÂà§ÂÆöÔºâ
            if(Math.abs(b.x - e.x) > collisionR || Math.abs(b.y - e.y) > collisionR) continue;

            // Ë∑ùÈõ¢„ÅÆ‰∫å‰πó„ÅßÂà§ÂÆö (sqrt„Çí‰Ωø„Çè„Å™„ÅÑ)
            let distSq = (b.x - e.x)**2 + (b.y - e.y)**2;
            if(distSq < collisionR * collisionR) {

                if(b.type === 'missile') {
                    Sound.play('explode');
                    particles.push({type:'shockwave', x:b.x, y:b.y, size:10, life:15, color:'#f80'});
                    let blastR = 100 * stats.missileBlast;
                    let blastDmg = stats.dmg * 3 * stats.missileBlast;
                    enemies.forEach(subE => { 
                        if(!subE.dead && Math.hypot(subE.x - b.x, subE.y - b.y) < blastR) {
                            damageEnemy(subE, blastDmg);
                            if(stats.napalm && Math.random()<0.5) gasClouds.push({x:subE.x, y:subE.y, r:30, life:120, dmg:stats.dmg*0.2});
                        }
                    });
                    if(particles.length < MAX_PARTICLES) createParticles(b.x, b.y, '#f00', 10 * stats.missileBlast, 5 * stats.missileBlast);
                    bullets.splice(i, 1); hit = true; break;
                } else {
                    let finalDmg = stats.dmg * (b.damageMult || 1);
                    damageEnemy(e, finalDmg);

                    if(stats.coldFlask && Math.random() < 0.1) {
                        e.frozen = 60; 
                        createParticles(e.x, e.y, '#0ff', 5, 2);
                    }
                    // --- ‚òÖ‰øÆÊ≠£: „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÂá¶ÁêÜ („ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„Å®„Éú„ÇπËÄêÊÄß„ÇíÈÅ©Áî®) ---
                    // Êù°‰ª∂: „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÂÄ§„Åå„ÅÇ„Çä„ÄÅ„Éü„ÉãÂºæ„Åß„ÅØ„Å™„Åè„ÄÅÊïµ„Åå„Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÂæÖÊ©üÁä∂ÊÖã„Åß„Å™„ÅÑ„Åì„Å®
                    if(stats.knockback > 0 && !b.isMini && e.knockbackTimer <= 0) {
                        let ang = Math.atan2(e.y - player.y, e.x - player.x);
                        let force = stats.knockback * 20;

                        // „Éú„ÇπËÄêÊÄß: ÂäπÊûú„Çí 1/10 „Å´Ê∏õ„Çâ„Åô
                        if(e.type === 'boss') {
                            force *= 0.1;
                        }

                        e.x += Math.cos(ang) * force;
                        e.y += Math.sin(ang) * force;

                        // ÂÜÖÈÉ®„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„ÇíË®≠ÂÆö (Âçò‰Ωç: „Éï„É¨„Éº„É†)
                        // ÈÄöÂ∏∏Êïµ: 10„Éï„É¨„Éº„É†(Á¥Ñ0.16Áßí)Èñì„ÅØÊ¨°„ÅÆ„Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ„ÇíÂèó„Åë„Å™„ÅÑ
                        // „Éú„Çπ:   20„Éï„É¨„Éº„É†(Á¥Ñ0.33Áßí)Èñì„ÅØÊ¨°„ÅÆ„Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ„ÇíÂèó„Åë„Å™„ÅÑ
                        e.knockbackTimer = (e.type === 'boss') ? 20 : 10;
                    }
                    if(stats.clusterStriker && !b.isMini) {
                         Sound.play('explode', 2.0);
                         for(let k=0; k<6; k++) {
                             let ang = (Math.PI*2/6)*k;
                             bullets.push({type:'missile', x:e.x, y:e.y, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5, size:4, speed:0, hit:[e.id], isMini:true});
                         }
                    }
                    if(stats.prismSplit && !b.isMini && (b.splitCount || 0) < 2) {
                        for(let k=0; k<2; k++) {
                             let ang = Math.atan2(b.vy, b.vx) + (k===0 ? 0.5 : -0.5);
                             bullets.push({
                                 type:'normal', x:e.x, y:e.y, 
                                 vx:Math.cos(ang)*stats.bulletSpeed, vy:Math.sin(ang)*stats.bulletSpeed, 
                                 size:b.size*0.8, hit:[e.id], pierce:0, isMini:false, color:'#f0f',
                                 splitCount: (b.splitCount||0)+1
                             });
                        }
                    }
                    if(stats.absoluteZero && Math.random()<0.3) e.frozen = 60; 
                    if(stats.shotExplode) { 
                        Sound.play('explode', 2.0);
                        enemies.forEach(subE => { if(!subE.dead && Math.hypot(subE.x-e.x, subE.y-e.y) < 50) damageEnemy(subE, stats.dmg*0.5); });
                        createParticles(e.x, e.y, '#fa0', 3, 2);
                    }
                    if(stats.napalm && Math.random()<0.2) gasClouds.push({x:e.x, y:e.y, r:20, life:100, dmg:stats.dmg*0.2});
                    
                    if(stats.splitShot && !b.isMini) { 
                        for(let k=0; k<2; k++) {
                            let ang = (Math.random()*Math.PI*2);
                            bullets.push({type:'normal', x:e.x, y:e.y, vx:Math.cos(ang)*10, vy:Math.sin(ang)*10, size:3, hit:[e.id], pierce:0, isMini:true});
                        }
                    }

                    if(stats.lightning > 0) triggerLightning(e, stats.lightning);
                    b.hit.push(e.id);
                    if(particles.length < MAX_PARTICLES) createParticles(b.x, b.y, '#ffffaa', 3, 2); 
                    
                    if(b.pierce <= 0 && !stats.infinitePierce) { bullets.splice(i, 1); hit = true; break; } 
                    else { b.pierce--; }
                }
            }
        }
        if(hit) continue;
    }

    for(let i=enemyBullets.length-1; i>=0; i--) {
        let b = enemyBullets[i];
        b.x += b.vx * ts; b.y += b.vy * ts;
        if(b.x < -100 || b.x > canvas.width+100 || b.y < -100 || b.y > canvas.height+100) { enemyBullets.splice(i, 1); continue; }
        if(Math.hypot(player.x-b.x, player.y-b.y) < player.size + b.size) { 
            let dmg = 10 + Math.floor(level * 0.5);
            takeDamage(dmg); 
            enemyBullets.splice(i, 1); 
        }
    }

    if(enemies.length < MAX_ENEMIES) {
        let spawnDenom = Math.max(5, 25 - (level * 0.6)); 
        let hordeMult = 1.0;
        if (level >= 5) {
            let progress = Math.min(1.0, (level - 5) / 25);
            hordeMult = 2.0 + progress; 
        }
        if (singularityMode) hordeMult *= 3.0;

        let spawnProb = (hordeMult / spawnDenom) * ts;
        if(player.hp >= player.maxHp * 0.9) {
            spawnProb *= 3.0; 
        }

        if(Math.random() < spawnProb) spawnEnemy('random', gameTimeSec);
    }

    let cycleTime = gameTimeSec % 300; 
    let cycleWave = Math.floor(gameTimeSec / 300);

    if(cycleTime > 295 && !bossWarningActive && cycleWave === bossCycleCounter) {
        bossWarningActive = true;
        triggerWarning();
    }
    if(cycleWave > bossCycleCounter) {
        bossCycleCounter = cycleWave;
        bossWarningActive = false;
        document.getElementById('warning-overlay').style.display = 'none';
        spawnEnemy('boss', gameTimeSec); 
    }

    enemies.forEach(e => {
        if(e.dead) return;

        if(e.knockbackTimer > 0) e.knockbackTimer -= ts;
        
        if(e.frozen > 0) { 
            e.frozen -= ts;
            if(Math.random()<0.1 && particles.length < MAX_PARTICLES) createParticles(e.x, e.y, '#88ffff', 1, 1);
        } else {
            let dist = Math.hypot(player.x - e.x, player.y - e.y);
            let angle = Math.atan2(player.y - e.y, player.x - e.x);
            if (e.flash > 0) e.flash -= ts;
            
            if(e.ai === 'dasher') {
                if(e.state === 'chase') {
                    e.x += Math.cos(angle) * e.speed * ts; e.y += Math.sin(angle) * e.speed * ts;
                    if(dist < 250) { e.state = 'aim'; e.timer = 30; } 
                } else if(e.state === 'aim') {
                    e.timer -= ts; if(e.timer <= 0) { e.state = 'dash'; e.timer = 30; e.vx = Math.cos(angle) * 14; e.vy = Math.sin(angle) * 14; }
                } else if(e.state === 'dash') {
                    e.x += e.vx * ts; e.y += e.vy * ts; e.timer -= ts; 
                    if(Math.random() < 0.5 * ts && particles.length < MAX_PARTICLES) createParticles(e.x, e.y, '#f80', 1, 2);
                    if(e.timer <= 0) { e.state = 'cooldown'; e.timer = 50; }
                } else if(e.state === 'cooldown') { e.timer -= ts; e.x += Math.cos(angle) * (e.speed * 0.2) * ts; if(e.timer <= 0) e.state = 'chase'; }
            } else if(e.ai === 'shooter') {
                if(dist > 250) { e.x += Math.cos(angle) * e.speed * ts; e.y += Math.sin(angle) * e.speed * ts; }
                else if(dist < 150) { e.x -= Math.cos(angle) * e.speed * 0.5 * ts; e.y -= Math.sin(angle) * e.speed * 0.5 * ts; }
                if(Math.random() < (1/120)*ts && dist < 600) { enemyBullets.push({x: e.x, y: e.y, vx: Math.cos(angle)*6, vy: Math.sin(angle)*6, size: 6, color: '#f0a'}); }
            } else if(e.ai === 'bat') {
                let zig = Math.sin(gameTimeSec * 5) * 0.8;
                e.x += Math.cos(angle + zig) * e.speed * ts; e.y += Math.sin(angle + zig) * e.speed * ts;
            } else {
                e.x += Math.cos(angle) * e.speed * ts; e.y += Math.sin(angle) * e.speed * ts;
            }

            if(dist < player.size + e.size) {
                if(stats.spikeArmor && Math.random() < 0.2 * ts) {
                    damageEnemy(e, stats.dmg * 0.5);
                    if(particles.length < MAX_PARTICLES) createParticles((player.x+e.x)/2, (player.y+e.y)/2, '#fff', 1, 2);
                }
                
                // ‚òÖ„ÄêÂ§âÊõ¥ÁÇπ„ÄëÂèçÂ∞Ñ„ÉÄ„É°„Éº„Ç∏„ÇíË∂ÖÂº∑Âåñ
                if(stats.spikeReflect) { 
                    // Êïµ„ÅÆÊîªÊíÉÂäõ„ÅÆ2ÂÄç + Èò≤Âæ°Âäõ„ÅÆ50ÂÄç „ÇíËøî„Åô
                    let reflectDmg = (e.dmg * 2.0) + (stats.armor * 50);
                    damageEnemy(e, reflectDmg);
                    Sound.play('hit');
                    if(particles.length < MAX_PARTICLES) createParticles(e.x, e.y, '#0f0', 3, 2);
                }

                if(stats.isEarthShaker) {
                    damageEnemy(e, stats.dmg * 2); 
                    Sound.play('bash');
                    let kickAng = Math.atan2(e.y - player.y, e.x - player.x);
                    e.x += Math.cos(kickAng) * 30; e.y += Math.sin(kickAng) * 30;
                }
                
                if(player.class === 'Melee' && player.slamCd <= 0) {
                    let cd = Math.max(10, 60 - stats.rate);
                    player.slamCd = cd; 

                    // ‚òÖ„ÄêÂ§âÊõ¥ÁÇπ„Äë‰ΩìÂΩì„Åü„Çä„Å´ÊúÄÂ§ßHP‰æùÂ≠ò„ÉÄ„É°„Éº„Ç∏„ÇíËøΩÂä† (MaxHP„ÅÆ20%)
                    let slamBonus = player.maxHp * 0.2; 
                    damageEnemy(e, (stats.dmg * 2) + slamBonus); 

                    let waveSize = 15 + (stats.pierce * 5); 
                    Sound.play('bash');
                    if(particles.length < MAX_PARTICLES) createParticles(e.x, e.y, '#fff', 5, 2);
                    particles.push({type:'shockwave', x:player.x, y:player.y, size:waveSize, life:10, color:'#f00'});
                    
                    // Ë°ùÊíÉÊ≥¢„ÅÆ„ÉÄ„É°„Éº„Ç∏„Å´„ÇÇHP„Éú„Éº„Éä„Çπ„ÇíÂ∞ë„Åó‰πó„Åõ„Çã
                    enemies.forEach(subE => {
                        if(!subE.dead && Math.hypot(subE.x - player.x, subE.y - player.y) < waveSize * 3) {
                            damageEnemy(subE, (stats.dmg * 0.5) + (slamBonus * 0.5));
                        }
                    });
                } else {
                    let contactDmg = e.dmg; 
                    takeDamage(contactDmg);
                }
            }
        }
    });
    
    enemies = enemies.filter(e => !e.dead);

    if(expOrbs.length > MAX_ORBS) {
        let removed = expOrbs.splice(0, expOrbs.length - MAX_ORBS);
        removed.forEach(o => { 
            if(gameActive) {
                addExp(Math.floor(o.val * 0.7), true); 
            }
        });
    }
    for(let i=expOrbs.length-1; i>=0; i--) {
        if(!gameActive) break; 
        let o = expOrbs[i];
        
        let d = Math.hypot(player.x - o.x, player.y - o.y);

        if(o.forceCollect) {
            o.x += (player.x - o.x) * 0.2 * ts; 
            o.y += (player.y - o.y) * 0.2 * ts;
        } else if(d < stats.magnet) {
            o.x += (player.x - o.x) * 0.25 * ts; 
            o.y += (player.y - o.y) * 0.25 * ts; 
        }
        
        if(d < 20) { addExp(o.val); Sound.play('exp', o.pitch); expOrbs.splice(i, 1); }
    }

    for(let i=items.length-1; i>=0; i--) {
        let it = items[i];
        let d = Math.hypot(player.x - it.x, player.y - it.y);
        if(d < 200) {
            it.x += (player.x - it.x) * 0.1 * ts;
            it.y += (player.y - it.y) * 0.1 * ts;
        }
        if(d < 30) {
            if(it.type === 'magnet') {
                Sound.play('powerup');
                particles.push({type:'shockwave', x:player.x, y:player.y, size:500, life:30, color:'#fff'});
                expOrbs.forEach(o => o.forceCollect = true);
            } else if(it.type === 'bomb') {
                triggerBomb();
            }
            items.splice(i, 1);
        }
    }

    if(particles.length > MAX_PARTICLES) particles.splice(0, particles.length - MAX_PARTICLES);
    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i];
        if(p.type === 'lightning') { p.life -= ts; } 
        else if(p.type === 'shockwave') { p.size += 3 * ts; p.life -= ts; } 
        else { p.x += p.vx * ts; p.y += p.vy * ts; p.life -= ts; p.size *= 0.9; }
        if(p.life <= 0) particles.splice(i, 1);
    }
    
    if(texts.length > MAX_TEXTS) texts.splice(0, texts.length - MAX_TEXTS);
    for(let i=texts.length-1; i>=0; i--) {
        texts[i].y -= 1 * ts; texts[i].life -= ts;
        if(texts[i].life<=0) texts.splice(i, 1);
    }
}

function triggerBomb() {
    Sound.play('bomb');
    let overlay = document.getElementById('bomb-overlay');
    overlay.style.display = 'block';
    overlay.style.opacity = '0.8';
    setTimeout(() => { overlay.style.opacity = '0'; setTimeout(()=>overlay.style.display='none', 500); }, 100);

    enemies.forEach(e => {
        if(!e.dead && e.type !== 'boss') {
            damageEnemy(e, e.hp + 9999);
            createParticles(e.x, e.y, '#fff', 5, 5);
        }
    });
    screenShake = 30;
}

function shoot() {
    // --- ‰æç (Samurai) „ÅÆÁâπÊÆäÂ∞ÑÊíÉ ---
    if(stats.samuraiMode) {
        let target = null, minD = Infinity;
        enemies.forEach(e => { if(e.dead) return; let d = Math.hypot(e.x-player.x, e.y-player.y); if(d<minD){minD=d; target=e;} });
        
        let angle = target ? Math.atan2(target.y-player.y, target.x-player.x) : (player.isMoving ? Math.atan2(joyMoveY||0, joyMoveX||1) : -Math.PI/2);
        if(!target && !player.isMoving && joyTouchId === null) angle = -Math.PI/2; 

        // ÂºæÈÄü„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèçÊò†
        let slashSpeed = stats.bulletSpeed * 0.9; 
        
        // ‚òÖ‰øÆÊ≠£1: „Åì„Åì„Å´„ÅÇ„Å£„Åü "let bSize = ..." „ÅÆË°å„ÇíÂâäÈô§„Åó„Åæ„Åó„ÅüÔºà„Ç®„É©„Éº„ÅÆÂéüÂõ†„Å´„Å™„Çã„Åü„ÇÅÔºâ

        Sound.play('missile', 2.0); 
        bullets.push({
            type: 'slash', x: player.x, y: player.y, 
            vx: Math.cos(angle) * slashSpeed, vy: Math.sin(angle) * slashSpeed, 
            angle: angle,
            size: 220 * stats.areaScale, // „Åì„Åì„ÅßÊ≠£„Åó„Åè„Çµ„Ç§„Ç∫ÂÄçÁéá„ÇíÈÅ©Áî®„Åó„Å¶„ÅÑ„Åæ„Åô
            life: 15,  
            color: '#fff', hit: new Set(), pierce: 999, 
            damageMult: 1.0
        });
        
        // ËøΩÂä†ÂäπÊûú: ÊäúÂàÄ„ÅÆË°ùÊíÉÊ≥¢
        if(stats.swordWave || stats.multi > 1) {
             let waveCount = stats.multi;
             
             let waveDmgMult = 1.0;
             let waveSize = 5 * stats.areaScale; // ‚òÖË°ùÊíÉÊ≥¢„Å´„ÇÇ„Çµ„Ç§„Ç∫ÈÅ©Áî®
             
             if(waveCount > 6) {
                 let extra = waveCount - 6;
                 waveDmgMult += extra * 0.3; 
                 waveSize += Math.min(15, extra * 0.5); 
                 waveCount = 6; 
             }

             for(let i=0; i<waveCount; i++) {
                 let waveAng = angle + (Math.random()-0.5)*0.5;
                 bullets.push({
                    type:'normal', 
                    x:player.x, y:player.y, 
                    vx:Math.cos(waveAng)*stats.bulletSpeed*1.2, 
                    vy:Math.sin(waveAng)*stats.bulletSpeed*1.2, 
                    size:waveSize, 
                    color:'#adf', 
                    pierce:5, 
                    life:40,
                    hit: [],  
                    damageMult: waveDmgMult
                });
             }
        }
        return; 
    }
    // ----------------------------

    let target = null;
    let minD = Infinity;
    
    enemies.forEach(e => {
        if (e.dead) return;
        let d = Math.hypot(e.x - player.x, e.y - player.y);
        if (d < minD) { minD = d; target = e; }
    });

    let angle;
    if (target) { angle = Math.atan2(target.y - player.y, target.x - player.x); } 
    else { angle = Math.random() * Math.PI * 2; }

    let count = stats.multi;
    if(player.class === 'Sniper') count = 1; 
    if(stats.infiniteMag) count += 3; 
    
    let currentDmg = stats.dmg;
    if(stats.siegeMode && stats.isStationary) currentDmg *= 2;
    if(stats.doubleShot && Math.random() < 0.5) count *= 2; 

    let bDmgMultBase = 1.0;
    let bSizeBase = stats.railgun ? 10 : 5;
    
    if(count > 20) {
        let extra = count - 20;
        bDmgMultBase += extra * 0.1; 
        count = 20; 
    }

    let spread = 0.1;
    if(stats.bulletStorm) {
        spread = 0.5 + Math.sin(Date.now()*0.01)*0.5; 
        count += 3; 
    }
    let startAngle = angle - (spread * (count-1)) / 2;

    for(let i=0; i<count; i++) {
        let currentAngle = startAngle + spread * i;
        let vx = Math.cos(currentAngle) * stats.bulletSpeed;
        let vy = Math.sin(currentAngle) * stats.bulletSpeed;
        
        let bType = 'normal';
        let bColor = stats.ghostShot ? '#88ff88' : (stats.prismSplit ? '#f0f' : '#fff');
        let bDmgMult = bDmgMultBase;
        
        // ‚òÖ‰øÆÊ≠£2: „Åì„Åì„Åß stats.areaScale „ÇíÊéõ„Åë„Å¶„ÄÅÈÄöÂ∏∏Âºæ„ÇÇÂ∑®Â§ßÂåñ„Åô„Çã„Çà„ÅÜ„Å´‰øÆÊ≠£
        let bSize = bSizeBase * stats.areaScale; 

        if(stats.tempestMode) {
             bColor = '#d0f'; 
             bSize = 6 * stats.areaScale; // Èõ∑Â∏ù„ÅÆÂºæ„Å´„ÇÇÈÅ©Áî®
        }

        if(stats.tricksterMode) {
            let cols = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
            bColor = cols[Math.floor(Math.random()*cols.length)];
            if(stats.chaosShot) bSize = (3 + Math.random() * 10) * stats.areaScale;
            let roll = Math.random();
            
            // ‚ñº Ë™øÊï¥: Ë≤´ÈÄö„ÇÑ„Éõ„Éº„Éü„É≥„Ç∞„ÅÆÁ¢∫Áéá„ÇíÂ∞ë„Åó‰∏ä„Åí„ÄÅÂàùÊúü„ÅÆ‰Ωø„ÅÑÂãùÊâã„ÇíÂêë‰∏ä
            if(roll < 0.25) stats.pierce = 99; // 0.2 -> 0.25
            else if(roll < 0.5) stats.homing = 1; // 0.4 -> 0.5 (homing chance up)
            else stats.homing = 0;

            if(stats.russianRoulette) {
                // ‚ñº Ë™øÊï¥: „Éè„Ç∫„É¨ÊôÇ„ÅÆ„ÉÄ„É°„Éº„Ç∏ÂÄçÁéá„Çí 0.1 -> 0.5 „Å´Á∑©Âíå
                if(Math.random() < 0.16) { bDmgMult *= 10; bSize *= 2; bColor='#fff'; } 
                else if(Math.random() < 0.1) { bDmgMult *= 0.5; bSize = 2; bColor='#444'; } // „Éè„Ç∫„É¨„Å¶„ÇÇÂçäÂàÜ„ÅØÂÖ•„Çã
            }
        }

        bullets.push({
            type: bType, x: player.x, y: player.y,
            vx: vx, vy: vy,
            size: bSize, color: bColor,
            hit: [], pierce: stats.pierce,
            damageMult: bDmgMult, isMini: false
        });
    }

    if(stats.doppelganger && player.clone) {
        bullets.push({
            type: 'normal', x: player.clone.x, y: player.clone.y,
            vx: -Math.cos(startAngle)*stats.bulletSpeed, vy: -Math.sin(startAngle)*stats.bulletSpeed,
            size: 5 * stats.areaScale, // ÂàÜË∫´„ÅÆÂºæ„Å´„ÇÇÈÅ©Áî®
            color: '#fff', hit: [], pierce: stats.pierce, damageMult: 1, isMini: false
        });
    }

    if(stats.missileChance > 0 && Math.random() < stats.missileChance) fireMissile();
    Sound.play('shoot', 1.0 + Math.random()*0.2);
}

function dash() {
    if(player.dashCd > 0) return;
    player.dashCd = player.maxDashCd;
    player.invincible = 30; // 0.5s invincible
    
    let dx = 0, dy = 0;
    if(keys['w'] || keys['ArrowUp']) dy = -1;
    if(keys['s'] || keys['ArrowDown']) dy = 1;
    if(keys['a'] || keys['ArrowLeft']) dx = -1;
    if(keys['d'] || keys['ArrowRight']) dx = 1;
    
    if(joyTouchId !== null) { dx = joyMoveX; dy = joyMoveY; }
    
    if(dx === 0 && dy === 0) dx = 1; 

    let len = Math.hypot(dx, dy);
    if(len > 0) { dx /= len; dy /= len; }

    player.x += dx * 100;
    player.y += dy * 100;
    player.x = Math.max(15, Math.min(canvas.width-15, player.x));
    player.y = Math.max(15, Math.min(canvas.height-15, player.y));
    
    if(stats.clusterMine) {
         for(let i=0; i<3; i++) {
             let mx = player.x - dx * (20 + i*10);
             let my = player.y - dy * (20 + i*10);
             bullets.push({type:'missile', x:mx, y:my, vx:0, vy:0, speed:0, size:5, hit:[], isMini:false});
         }
    }

    createParticles(player.x, player.y, '#fff', 10, 2);
    Sound.play('dash'); 
}

function spawnSentry() {
    if(sentries.length >= stats.sentryMax) sentries.shift(); // Use max limit
    sentries.push({x: player.x, y: player.y, cooldown: 0});
    createParticles(player.x, player.y, '#0f0', 10, 3);
    Sound.play('spark');
}

function pointToLineDistance(px, py, x1, y1, x2, y2) {
    let A = px - x1; let B = py - y1;
    let C = x2 - x1; let D = y2 - y1;
    let dot = A * C + B * D;
    let len_sq = C * C + D * D;
    let param = -1;
    if (len_sq !== 0) param = dot / len_sq;
    let xx, yy;
    if (param < 0) { xx = x1; yy = y1; }
    else if (param > 1) { xx = x2; yy = y2; }
    else { xx = x1 + param * C; yy = y1 + param * D; }
    let dx = px - xx; let dy = py - yy;
    return Math.hypot(dx, dy);
}

function fireMissile() {
    Sound.play('missile');
    bullets.push({ type: 'missile', x: player.x, y: player.y, vx: (Math.random()-0.5)*4, vy: -5, speed: 10, size: 8, hit: [], isMini: false });
}

function fireOmegaLaser() {
    Sound.play('laser');
    screenShake = 10;
    bullets.push({ type: 'omega', x: player.x, y: player.y, vx: 50, vy: 0, size: 300, life: 30, hit: [], tick: 0 });
    particles.push({type:'shockwave', x:player.x, y:player.y, size:100, life:20, color:'#f0f'});
}

function fireChakram() {
    let ang = Math.random() * Math.PI * 2;
    bullets.push({ 
        type: 'chakram', x: player.x, y: player.y, 
        vx: Math.cos(ang)*12, vy: Math.sin(ang)*12, 
        size: 10 + stats.chakram*2, life: 180 + stats.chakram*30, 
        hit: [], bounceCd: 0 
    });
}

function triggerLightning(target, lv) {
    let range = 200 + (lv * 30); let count = 0; let maxTargets = lv; 
    enemies.forEach(e => {
        if(!e.dead && e !== target && count < maxTargets) {
            if(Math.hypot(e.x - target.x, e.y - target.y) < range) {
                damageEnemy(e, stats.dmg * 0.8);
                createLightningEffect(target.x, target.y, e.x, e.y);
                Sound.play('lightning'); count++;
            }
        }
    });
}
function createLightningEffect(x1, y1, x2, y2) { 
    if(particles.length > MAX_PARTICLES) return;
    particles.push({ type: 'lightning', x1: x1, y1: y1, x2: x2, y2: y2, life: 10, color: '#88ffff' }); 
}

function takeDamage(dmg) {
    if(Math.random() < stats.dodge) {
        // ÂõûÈÅøÊàêÂäüÔºÅ
        if(texts.length < MAX_TEXTS) texts.push({x:player.x, y:player.y-20, str:"MISS", life:30, color:'#88ff88'});
        return; 
    }
    
    if(stats.forceField && stats.forceFieldCd <= 0) {
        stats.forceFieldCd = 300; 
        Sound.play('bounce');
        particles.push({type:'shockwave', x:player.x, y:player.y, size:50, life:20, color:'#0ff'});
        return; 
    }
    
    if(player.invincible > 0) return;
    
    dmg = Math.max(1, dmg - stats.armor);

    player.hp -= dmg; 
    player.invincible = 20; 
    screenShake = 15;
    createParticles(player.x, player.y, '#f00', 10, 4); updateUI();
    
    if(stats.reactiveArmor) {
        Sound.play('spark');
        particles.push({type:'shockwave', x:player.x, y:player.y, size:150, life:10, color:'#0f0'});
        enemies.forEach(e => {
             if(!e.dead && Math.hypot(e.x - player.x, e.y - player.y) < 150) {
                 damageEnemy(e, stats.dmg);
                 let ang = Math.atan2(e.y - player.y, e.x - player.x);
                 e.x += Math.cos(ang) * 50; e.y += Math.sin(ang) * 50; 
             }
        });
    }

    if(player.hp <= 0) gameOver();
}

function draw() {
    let shakeX = (Math.random() - 0.5) * screenShake;
    let shakeY = (Math.random() - 0.5) * screenShake;
    ctx.save(); ctx.translate(shakeX, shakeY);

    ctx.fillStyle = '#050505'; ctx.fillRect(-20, -20, canvas.width+40, canvas.height+40);
    
    ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 1; ctx.beginPath();
    for(let i=0; i<canvas.width; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); }
    for(let i=0; i<canvas.height; i+=100) { ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); }
    ctx.stroke();

    // ‚òÖËªΩÈáèÂåñ: Â∑®Â§ß„Å™ÂÜÜ„Å™„Å©„ÅÆÊèèÁîª„ÇíÁ∞°Á¥†ÂåñÔºàshadowBlurÂâäÈô§„Å™„Å©Ôºâ

    if(stats.absoluteZero) {
        ctx.fillStyle = 'rgba(0, 255, 255, 0.05)';
        ctx.beginPath(); ctx.arc(player.x, player.y, 250, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)'; ctx.lineWidth=1; ctx.stroke();
    }
    if(stats.electroFence) {
        ctx.strokeStyle = `rgba(136, 255, 255, ${(electroFenceTimer/60)})`;
        ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(player.x, player.y, 150, 0, Math.PI*2); ctx.stroke();
    }

    gasClouds.forEach(g => { ctx.fillStyle = `rgba(100, 0, 150, ${g.life/100})`; ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill(); });

    sentries.forEach(s => {
        ctx.fillStyle = '#0f0'; ctx.fillRect(s.x-10, s.y-10, 20, 20);
        ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.strokeRect(s.x-10, s.y-10, 20, 20);
    });
    if(stats.teslaGrid && sentries.length >= 2) {
        ctx.strokeStyle = '#0ff'; ctx.lineWidth = 3; // shadowBlurÂâäÈô§
        ctx.beginPath();
        ctx.moveTo(sentries[0].x, sentries[0].y);
        for(let i=1; i<sentries.length; i++) ctx.lineTo(sentries[i].x, sentries[i].y);
        ctx.lineTo(sentries[0].x, sentries[0].y);
        ctx.stroke();
    }

    if(player.class === 'Melee' && flyingSwords.length > 0) {
        ctx.fillStyle = '#f0a';
        flyingSwords.forEach(sw => {
            ctx.save(); ctx.translate(sw.x, sw.y); ctx.rotate(Date.now()*0.1);
            ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(5, 5); ctx.lineTo(-5, 5); ctx.fill();
            ctx.restore();
            ctx.strokeStyle = 'rgba(255, 0, 100, 0.3)'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(player.x, player.y); ctx.lineTo(sw.x, sw.y); ctx.stroke();
        });
    }

    if(player.class === 'Melee' && spikeBits.length > 0) {
        ctx.fillStyle = '#f00';
        spikeBits.forEach(bit => {
            ctx.beginPath(); ctx.moveTo(bit.x, bit.y - 8); ctx.lineTo(bit.x + 6, bit.y + 6); ctx.lineTo(bit.x - 6, bit.y + 6); ctx.fill();
        });
    }

    if(stats.aura) {
        ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(Date.now() * 0.005);
        let r = stats.auraRange * stats.auraScale * stats.areaScale;
        let auraColor = '0, 255, 255';
        if(player.subClass === 'SunCrusher') {
            auraColor = '255, 100, 0'; 
            if(player.isMoving) r += player.sunCharge * 2;
        }

        let grad = ctx.createRadialGradient(0, 0, r*0.5, 0, 0, r);
        grad.addColorStop(0, `rgba(${auraColor}, 0)`); grad.addColorStop(0.8, `rgba(${auraColor}, 0.2)`);
        if(stats.gravityAura) grad.addColorStop(0.9, 'rgba(100, 0, 200, 0.4)'); 
        if(stats.blackHole) { grad.addColorStop(1, 'rgba(0, 0, 0, 0.6)'); ctx.strokeStyle='#f0f'; } 
        else ctx.strokeStyle = `rgba(${auraColor}, 0.5)`;
        
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fill();
        ctx.lineWidth = 2;
        ctx.beginPath(); for(let i=0; i<3; i++) { ctx.rotate(Math.PI*2/3); ctx.moveTo(r * 0.6, 0); ctx.lineTo(r, 0); }
        ctx.stroke(); ctx.restore();
    }

    ctx.fillStyle = '#0ff';
    orbitals.forEach(o => { ctx.beginPath(); ctx.arc(o.x, o.y, 8, 0, Math.PI*2); ctx.fill(); });
    
    drones.forEach(d => {
        ctx.save(); ctx.translate(d.x, d.y); ctx.rotate(Date.now() * 0.01);
        ctx.fillStyle = '#ff0'; ctx.fillRect(-6, -6, 12, 12);
        ctx.strokeStyle = '#fff'; ctx.strokeRect(-6, -6, 12, 12);
        ctx.restore();
    });

    if(stats.forceField && stats.forceFieldCd <= 0) {
        ctx.strokeStyle = `rgba(0, 255, 255, 0.8)`; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(player.x, player.y, player.size + 10, 0, Math.PI*2); ctx.stroke();
    }

    items.forEach(it => {
        ctx.save(); ctx.translate(it.x, it.y);
        let s = 1.0 + Math.sin(Date.now()*0.01)*0.2;
        ctx.scale(s, s);
        ctx.font = '24px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline='middle';
        if(it.type === 'magnet') ctx.fillText('üß≤', 0, 0);
        else if(it.type === 'bomb') ctx.fillText('üí£', 0, 0);
        ctx.restore();
    });

    if(player.invincible % 10 < 5) {
        // ‚ñº Êñ∞„Åó„ÅÑÊèèÁîªÈñ¢Êï∞„Çí‰ΩøÁî®
        drawPlayerSprite(ctx, player);
    }

    bullets.forEach(b => { 
        if(b.type === 'slash') {
            ctx.save();
            ctx.translate(b.x, b.y);
            ctx.rotate(b.angle);
            ctx.globalAlpha = Math.max(0, b.life / 15); 
            
            ctx.fillStyle = '#fff';
            // ‚òÖËªΩÈáèÂåñ: Êñ¨ÊíÉ„ÅÆÂΩ±„ÇÇÂâäÈô§
            ctx.beginPath();
            ctx.arc(0, 0, b.size, -Math.PI/1.8, Math.PI/1.8); 
            ctx.fill();

            ctx.strokeStyle = '#ccffff'; ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, 0); ctx.lineTo(b.size + 20, 0);
            ctx.stroke();
            
            ctx.restore();
            return;
        }

        if(b.type === 'omega') {
            ctx.fillStyle = `rgba(255, 0, 255, ${b.life/30})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff'; ctx.fillRect(0, b.y - 50, canvas.width, 100);
        }
        else if(b.type === 'missile') {
            ctx.fillStyle = '#f80'; ctx.beginPath(); ctx.moveTo(b.x, b.y-8); ctx.lineTo(b.x+6, b.y+6); ctx.lineTo(b.x-6, b.y+6); ctx.fill();
        } else if(b.type === 'chakram') {
            ctx.fillStyle = '#0ff'; ctx.save(); ctx.translate(b.x, b.y); ctx.rotate(Date.now() * 0.2);
            ctx.fillRect(-b.size/2, -b.size/2, b.size, b.size); ctx.restore();
        } else if(b.type === 'spirit') {
            ctx.fillStyle = '#8f8'; ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill();
        } else {
            let drawSize = (player.class === 'Sniper' && b.type === 'normal') ? 8 : b.size;
            if(b.isMini) drawSize = 2;
            ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, drawSize, 0, Math.PI*2); ctx.fill(); 
        }
    });
    
    // ‚òÖËªΩÈáèÂåñ: ÊïµÂºæ„ÅÆÂΩ±ÂâäÈô§
    ctx.fillStyle = '#fff'; 
    enemyBullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2); ctx.fill(); });

    enemies.forEach(e => {
        ctx.fillStyle = e.frozen > 0 ? '#0ff' : (e.flash > 0 ? '#fff' : e.color); 
        ctx.beginPath();
        if(e.type === 'boss') {
            // „Éú„Çπ„Å†„Åë„ÅØÁâπÂà•„Å™„ÅÆ„ÅßÂΩ±„ÇíÊÆã„Åó„Å¶„ÇÇËâØ„ÅÑ„Åå„ÄÅËªΩÈáèÂåñÂÑ™ÂÖà„ÅßÂâäÈô§
            ctx.fillRect(e.x-e.size, e.y-e.size, e.size*2, e.size*2);
            ctx.fillStyle = 'red'; ctx.fillRect(e.x-40, e.y-e.size-20, 80, 8); ctx.fillStyle = '#0f0'; ctx.fillRect(e.x-40, e.y-e.size-20, 80*(e.hp/e.maxHp), 8);
        } else if(e.type === 'golem') {
            ctx.fillRect(e.x-e.size, e.y-e.size, e.size*2, e.size*2);
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(e.x-e.size, e.y-e.size, e.size*2, e.size*2);
        } else {
            if(e.ai === 'dasher') { ctx.moveTo(e.x, e.y-e.size); ctx.lineTo(e.x+e.size, e.y+e.size); ctx.lineTo(e.x-e.size, e.y+e.size); ctx.closePath(); }
            else if(e.ai === 'splitter') { ctx.rect(e.x-e.size, e.y-e.size, e.size*2, e.size*2); }
            else if(e.ai === 'bat') { ctx.moveTo(e.x, e.y-e.size); ctx.lineTo(e.x+e.size, e.y); ctx.lineTo(e.x, e.y+e.size); ctx.lineTo(e.x-e.size, e.y); ctx.closePath(); }
            else if(e.ai === 'shooter') { ctx.rect(e.x-e.size, e.y-e.size, e.size*2, e.size*2); }
            else if(e.ai === 'tank') { for(let i=0; i<6; i++) { let ang = i * Math.PI / 3; let px = e.x + Math.cos(ang) * e.size; let py = e.y + Math.sin(ang) * e.size; if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py); } ctx.closePath(); }
            else { ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); }
            ctx.fill();
        }
    });

    expOrbs.forEach(o => { ctx.fillStyle = o.color; ctx.beginPath(); ctx.arc(o.x, o.y, o.size, 0, Math.PI*2); ctx.fill(); });
    
    particles.forEach(p => {
        if(p.type === 'lightning') {
            ctx.strokeStyle = p.color; ctx.lineWidth = 3; ctx.globalAlpha = p.life / 10; // shadowBlurÂâäÈô§
            ctx.beginPath(); ctx.moveTo(p.x1, p.y1);
            let midX = (p.x1 + p.x2) / 2 + (Math.random()-0.5)*30; let midY = (p.y1 + p.y2) / 2 + (Math.random()-0.5)*30;
            ctx.lineTo(midX, midY); ctx.lineTo(p.x2, p.y2); ctx.stroke(); ctx.globalAlpha = 1.0; 
        } else if(p.type === 'shockwave') {
            ctx.strokeStyle = p.color; ctx.lineWidth = 3; ctx.globalAlpha = p.life/15;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
        } else {
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 20; ctx.fillRect(p.x, p.y, p.size, p.size); ctx.globalAlpha = 1.0;
        }
    });

    ctx.font = 'bold 16px sans-serif';
    texts.forEach(t => { ctx.fillStyle = t.color || 'white'; ctx.fillText(t.str, t.x, t.y); });

    ctx.restore();
    let grad = ctx.createRadialGradient(player.x, player.y, 100, player.x, player.y, 800);
    grad.addColorStop(0, 'rgba(0,0,0,0)'); grad.addColorStop(1, 'rgba(0,0,0,0.6)');
    ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function spawnEnemy(mode, time) {
    if(enemies.length >= MAX_ENEMIES && mode !== 'boss') return; 

    let dist = Math.max(canvas.width, canvas.height)/2 + 50;
    let ang = Math.random()*Math.PI*2;
    let ex = player.x + Math.cos(ang)*dist; let ey = player.y + Math.sin(ang)*dist; let type = mode;
    if(mode === 'random') {
        let r = Math.random();
        
        // ‚òÖ Golem Spawn Logic
        let canGolem = level >= 50;
        
        let canSplitter = time > 45; let canBat = time > 90; let canDasher = time > 120; let canShooter = time > 150; let canTank = time > 180;
        
        if(canGolem && r < 0.08) type = 'golem'; 
        else if(canTank && r < 0.15) type = 'tank'; 
        else if(canShooter && r < 0.25) type = 'shooter'; 
        else if(canDasher && r < 0.35) type = 'dasher'; 
        else if(canSplitter && r < 0.45) type = 'splitter'; 
        else if(canBat && r < 0.6) type = 'bat'; 
        else type = 'normal';
    }
    createEnemy(type, ex, ey);
}

function createEnemy(type, x, y) {
    // 1. ÂÆöÁæ©„Éá„Éº„Çø„ÇíÂèñÂæóÔºàË©≤ÂΩì„Åå„Å™„Åë„Çå„Å∞normal„Çí‰Ωø„ÅÜÔºâ
    const data = ENEMY_DATA[type] || ENEMY_DATA['normal'];

    // 2. Âü∫Êú¨„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
    let e = { 
        id: Math.random(), 
        x: x, 
        y: y, 
        flash: 0, 
        type: (type === 'boss' || type === 'golem') ? type : 'mob', // boss„Å®golem‰ª•Â§ñ„ÅØmobÊâ±„ÅÑ
        ai: data.ai,
        frozen: 0, 
        knockbackTimer: 0 
    };
    
    // 3. HPË®àÁÆóÔºà„É¨„Éô„É´Ë£úÊ≠£Ôºâ
    let hpMult = Math.pow(1.10, level - 1); 
    if(singularityMode) hpMult *= 2.0;

    // „Éó„É¨„Ç§„É§„Éº„ÅåÂº∑„ÅÑÂ†¥Âêà„ÅÆÊïµÂº∑ÂåñË£úÊ≠£
    if (player.hp >= player.maxHp * 0.9) {
        if (level >= 60) hpMult *= 8.0;
        else if (level >= 40) hpMult *= 5.0;
    }

    e.hp = data.baseHp * hpMult;
    
    // 4. „Çµ„Ç§„Ç∫„Å®Ëâ≤
    e.size = data.size;
    e.color = data.color;

    // 5. ÈÄüÂ∫¶Ë®àÁÆó
    // Âü∫Êú¨ÈÄüÂ∫¶ + „É¨„Éô„É´Ë£úÊ≠£ + „É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†(ÈÄöÂ∏∏Êïµ„ÅÆ„Åø)
    let spdBase = data.baseSpeed + (level * 0.01 || 0); // undefinedÂØæÁ≠ñ
    if (type === 'normal') spdBase += Math.random(); // ÈÄöÂ∏∏Êïµ„ÅØÈÄüÂ∫¶„Éê„É©„Å§„Åç„ÅÇ„Çä
    
    // ÈÄüÂ∫¶ÂÄçÁéáÔºà„Ç¥„Éº„É¨„É†„ÅÆ0.3ÂÄç„Å™„Å©„ÇíÈÅ©Áî®Ôºâ
    let spdMult = (data.speedMult !== undefined) ? data.speedMult : 1.0;
    e.speed = spdBase * spdMult;

    // 6. „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÔºàÂÆöÁæ©„Åå„Å™„Åë„Çå„Å∞Ëá™ÂãïË®àÁÆóÔºâ
    e.dmg = 10 + Math.floor(level * 1.5);

    // 7. ÁâπÊÆäÂá¶ÁêÜÔºö„Éú„Çπ (Boss Specific Logic)
    if(type === 'boss') { 
        e.dmg = 50 + (level * 2);
        
        // „Çµ„Ç§„ÇØ„É´„ÅÆÂº∑Âåñ„É≠„Ç∏„ÉÉ„ÇØ
        let cycleMult = 1 + (bossCycleCounter * 0.5);
        if(bossCycleCounter >= 3) {
            let lateGameFactor = bossCycleCounter - 2;
            cycleMult *= Math.pow(1.15, lateGameFactor);
            // ÈÄüÂ∫¶‰∏äÈôê‰ªò„ÅçÂº∑Âåñ
            e.speed = Math.min(6.0, e.speed + (lateGameFactor * 0.5)); 
        }
        e.hp *= cycleMult;
    }

    // 8. „Ç∑„É≥„ÇÆ„É•„É©„É™„ÉÜ„Ç£„É¢„Éº„ÉâË£úÊ≠£
    if(singularityMode) { 
        e.color = '#000000'; 
        e.speed *= 1.2; 
    }

    e.maxHp = e.hp; // ÊúÄÂ§ßHPÁ¢∫ÂÆö
    enemies.push(e);
}

function damageEnemy(e, dmg) {
    if(e.dead) return; 
    
    // „Ç¨„Éº„Éá„Ç£„Ç¢„É≥„ÅÆÂõ∫ÂÆöÁ†≤Âè∞„Éú„Éº„Éä„Çπ
    if(stats.siegeMode && stats.isStationary) dmg *= 2;

    // --- ‚òÖÂ§âÊõ¥ÁÇπ1Ôºö„ÇØ„É™„ÉÜ„Ç£„Ç´„É´Ë®àÁÆó„ÅÆÂº∑Âåñ ---
    let isCrit = false;
    if(Math.random() < stats.critChance || stats.deadeye) { 
        // ‰ª•Ââç„ÅÆ„Äå3ÂÄç„Åã2ÂÄç„Äç„Å®„ÅÑ„ÅÜÂõ∫ÂÆöÂÄ§„Åß„ÅØ„Å™„Åè„ÄÅËÇ≤„Å¶„Åü stats.critMult „Çí‰Ωø„ÅÜ
        let multiplier = stats.deadeye ? (stats.critMult + 1.0) : stats.critMult;
        dmg *= multiplier; 
        isCrit = true; 
    } 
    
    // Êó¢Â≠ò„Çπ„Ç≠„É´Ôºö„Ç∏„É£„Ç§„Ç¢„É≥„Éà„Çπ„É¨„Ç§„É§„Éº
    if(stats.giantSlayer && (e.type === 'boss' || e.ai === 'tank')) dmg *= 2;
    // Êó¢Â≠ò„Çπ„Ç≠„É´ÔºöÂá¶Âàë‰∫∫
    if(stats.executioner && (e.hp < e.maxHp * 0.2)) dmg = e.hp + 999; 
    if(stats.execute && (e.hp < e.maxHp * 0.3)) dmg = e.hp + 9999; 

    // --- ‚òÖÂ§âÊõ¥ÁÇπ2ÔºöÊïµHP„Å´Âøú„Åò„ÅüÂâ≤Âêà„ÉÄ„É°„Éº„Ç∏ËøΩÂä†Ôºà„Ç∏„É£„Ç§„Ç¢„É≥„Éà„Ç≠„É©„ÉºÔºâ ---
    if(stats.hpDamage > 0) {
        // „Éú„ÇπÁõ∏Êâã„Å†„Å®Âº∑„Åô„Åé„ÇãÂ†¥Âêà„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅÊúÄÂ§ß„Åß„ÇÇ„ÄåÂü∫Êú¨„ÉÄ„É°„Éº„Ç∏„ÅÆ50ÂÄç„Äç„Åæ„Åß„Å´Âà∂Èôê„Åô„ÇãÂÆâÂÖ®Á≠ñ‰ªò„Åç
        let percentDmg = e.maxHp * stats.hpDamage;
        let cap = stats.dmg * 50; 
        dmg += Math.min(percentDmg, cap);
    }

    // --- ‚òÖÂ§âÊõ¥ÁÇπ3ÔºöËÉåÊ∞¥„ÉÄ„É°„Éº„Ç∏ÔºàÈÆÆË°Ä„ÅÆÁà™Ôºâ ---
    if(stats.lowHpDmg) {
        // HP„ÅåÊ∏õ„Å£„Å¶„ÅÑ„ÇãÂâ≤ÂêàÔºà0.0 ÔΩû 1.0Ôºâ
        let lostHpRatio = 1.0 - (player.hp / player.maxHp);
        // „ÉÄ„É°„Éº„Ç∏ÂÄçÁéáË®àÁÆóÔºàÊúÄÂ§ß3ÂÄçÔºâ
        dmg *= (1.0 + lostHpRatio * 2.0);
        
        // ÊºîÂá∫ÔºöÂ®ÅÂäõ„Åå‰∏ä„Åå„Å£„Å¶„ÅÑ„Çã„Å®„Åç„ÅØ„ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó„ÇíËµ§„Åè„Åô„Çã„Å™„Å©„ÅÆÂá¶ÁêÜ„ÇíÂÖ•„Çå„Çã„Å®ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ
        if(lostHpRatio > 0.5) isCrit = true; // ÊºîÂá∫Áî®
    }

    // --- „Åì„Åì„Åã„Çâ‰∏ã„ÅØÂ§âÊõ¥„Å™„Åó ---
    e.hp -= dmg; e.flash = 5; 
    
    if(particles.length < MAX_PARTICLES && Math.random() < 0.2) createParticles(e.x, e.y, '#fff', 1, 2); 
    Sound.play('hit');

    if(isCrit || e.type === 'boss' || texts.length < 5 || Math.random() < 0.2) {
        if(texts.length < MAX_TEXTS) texts.push({x:e.x, y:e.y, str:Math.floor(dmg), life:20, color: isCrit?'#ff0':'#fff'});
    }
    
    if(e.hp <= 0) {
        e.dead = true; 
        Sound.play('explode'); 
        screenShake = e.type === 'boss' ? 20 : 2; 

        if(stats.chainBurst) {
             Sound.play('explode', 2.0);
             let range = 100;
             let burstDmg = stats.dmg * 2;
             if(Math.random() < 0.3) createParticles(e.x, e.y, '#0ff', 5, 3);
             enemies.forEach(subE => {
                 if(!subE.dead && Math.hypot(subE.x-e.x, subE.y-e.y) < range) {
                     damageEnemy(subE, burstDmg);
                 }
             });
        }

        if(stats.shrapnel) {
            for(let i=0; i<3; i++) {
                let ang = Math.random() * Math.PI * 2;
                bullets.push({type:'normal', x:e.x, y:e.y, vx:Math.cos(ang)*8, vy:Math.sin(ang)*8, size:3, hit:[e.id], pierce:1, isMini:true, life:15});
            }
        }

        if(stats.necromancer) {
            bullets.push({type: 'spirit', x: e.x, y: e.y, vx: 0, vy: 0, speed: 8, size: 6, hit: [], isMini: false});
        }
        if(stats.bloodLust) { 
             player.hp = Math.min(player.maxHp, player.hp + player.maxHp * 0.01);
        }

        if(stats.jackpot && Math.random() < 0.05) { 
             Sound.play('levelup');
             for(let k=0; k<5; k++) {
                 let angle = Math.random() * Math.PI * 2;
                 let dist = Math.random() * 30;
                 expOrbs.push({x: e.x + Math.cos(angle)*dist, y: e.y + Math.sin(angle)*dist, size: 8, val: 100, color: '#ffd700', pitch: 1.5});
             }
             texts.push({x:e.x, y:e.y, str:"JACKPOT!", life:60, color:'#ffd700'});
        }

        if(stats.lifesteal > 0) { player.hp = Math.min(player.maxHp, player.hp + stats.lifesteal); updateUI(); }
        
        if(particles.length < MAX_PARTICLES) createParticles(e.x, e.y, e.color, e.type==='boss'?30:3, 4);

        let levelScaler = 1 + (level * 0.5); 
        if(singularityMode) levelScaler *= 2;
        let baseVal = 25 * levelScaler;
        let val = baseVal;
        if(e.type === 'boss') val = baseVal * 50;
        else if(e.ai === 'tank') val = Math.max(300, baseVal * 3);

        let orbType = { val: val, color: '#0ff', size: 4, pitch: 1.0 }; 
        if(val >= 20000) orbType = { val: val, color: '#f0f', size: 16, pitch: 0.5 }; 
        else if(val >= 6000) orbType = { val: val, color: '#f00', size: 14, pitch: 0.6 }; 
        else if(val >= 1500) orbType = { val: val, color: '#f80', size: 12, pitch: 0.7 }; 
        else if(val >= 300) orbType = { val: val, color: '#00f', size: 10, pitch: 0.8 }; 
        else if(val >= 80) orbType = { val: val, color: '#0f0', size: 8, pitch: 0.9 }; 
        
        if(e.ai === 'splitter') { createEnemy('minion', e.x+10, e.y); createEnemy('minion', e.x-10, e.y); }
        score += val; updateUI(); 
        
        expOrbs.push({x: e.x, y: e.y, size: orbType.size, val: orbType.val, color: orbType.color, pitch: orbType.pitch});

        if(Math.random() < 0.002) items.push({type: 'magnet', x: e.x, y: e.y});
        if(Math.random() < 0.0005) items.push({type: 'bomb', x: e.x, y: e.y});
    }
}

function addExp(v, silent) {
    if(!gameActive) return; 
    exp += v; 
    if(exp >= nextExp) { 
        exp = 0; level++; 
        if (level < 45) {
            // Lv50„Åæ„Åß„ÅØ‰ªä„Åæ„ÅßÈÄö„ÇäÔºà„Éè„Ç§„Éö„Éº„ÇπÔºâ
            nextExp = Math.floor(nextExp * 1.15) + 500;
        } else {
            // Lv50‰ª•Èôç„ÅØ‰º∏„Å≥„ÇíÁ∑©„ÇÑ„Åã„Å´„Åô„ÇãÔºà15%Â¢ó ‚Üí 2%Â¢ó„Å´„ÉÄ„Ç¶„É≥Ôºâ
            // „Åì„Çå„ÅßLv50‰ª•Èôç„ÇÇ„ÄÅ‰ªä„Åæ„Åß„Çà„Çä„Åö„Å£„Å®Êó©„Åè„É¨„Éô„É´„Åå‰∏ä„Åå„Çä„Åæ„Åô
            nextExp = Math.floor(nextExp * 1.02) + 1000;
        }
        Sound.play('levelup'); updateUI(); 
        
        if(level === 5) showEvo(); 
        else if(level === 40) showSecondEvo(); // ‚òÖ 2nd Evolution Trigger
        else if(level >= 20 && level % 10 === 0) showMilestone(); 
        else showUpgrade(); 
    }
    document.getElementById('xp-fill').style.width = Math.min(100, (exp/nextExp*100))+'%';
}

function showMilestone() {
    gameActive = false;
    Sound.play('milestone');
    let m = document.getElementById('menu-overlay'); 
    let c = document.getElementById('card-area');
    c.innerHTML = ''; 
    m.style.display = 'flex';
    document.querySelector('#menu-title').innerText = "Á¶ÅÊñ≠„ÅÆÂäõ (Lv"+level+")";

    // 1. ÂÄôË£ú„É™„Çπ„Éà„ÅÆ‰ΩúÊàê
    // („ÇØ„É©„Çπ„Åå‰∏ÄËá¥„ÄÅ„Åæ„Åü„ÅØÂÖ®„ÇØ„É©„ÇπÂÖ±ÈÄö) „Åã„Å§ („Åæ„Å†ÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑ)
    let pool = MILESTONE_DATA.filter(item => {
        let classMatch = !item.classes || item.classes.includes(player.class);
        let notOwned = !item.isOwned || !item.isOwned();
        return classMatch && notOwned;
    });

    // 2. „Ç∑„É£„ÉÉ„Éï„É´„Åó„Å¶3„Å§ÈÅ∏„Å∂
    pool.sort(() => Math.random() - 0.5);
    let opts = pool.slice(0, 3);

    // 3. Lv100‰ª•‰∏ä„ÅÆÁâπÁï∞ÁÇπ (Singularity) Âá¶ÁêÜ
    if(level >= 100) {
        let singOpt = {
            title: "üåå ÈôêÁïåÁ™ÅÁ†¥ (SINGULARITY)", 
            desc: "ÂÖ®„Çπ„ÉÜ„Éº„Çø„Çπ +20%UP", 
            f:()=>{
                stats.dmg*=1.2; stats.spd+=1; stats.rate*=0.9; 
                stats.bulletSpeed*=1.2; player.maxHp*=1.2; player.hp=player.maxHp;
            }
        };
        // Singularity„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶ËøΩÂä†
        let el = document.createElement('div'); el.className='card singularity';
        el.innerHTML = `<span class="icon">üåå</span><h3>${singOpt.title}</h3><p>${singOpt.desc}</p>`;
        el.onclick = () => { singOpt.f(); resume(); };
        c.appendChild(el);
        
        // ÈÄöÂ∏∏Êû†„Çí2„Å§„Å´Ê∏õ„Çâ„Åô
        opts = opts.slice(0, 2); 
    }

    // 4. „Ç´„Éº„ÉâÁîüÊàê
    opts.forEach(o => {
        let el = document.createElement('div'); el.className='card milestone';
        let icon = o.title.split(' ')[0]; 
        let title = o.title.split(' ').slice(1).join(' ');
        el.innerHTML = `<span class="icon">${icon}</span><h3>${title}</h3><p>${o.desc}</p>`;
        el.onclick = () => { o.f(); resume(); };
        c.appendChild(el);
    });

    // ‰∏á„Åå‰∏ÄÂÄôË£ú„Åå„Å™„ÅÑÂ†¥Âêà
    if(opts.length === 0 && level < 100) {
        let el = document.createElement('div'); el.className='card milestone';
        el.innerHTML = `<h3>LIMIT BREAK</h3><p>ÂÖ®„Çπ„ÉÜ„Éº„Çø„ÇπÂº∑Âåñ</p>`;
        el.onclick = () => { stats.dmg*=1.5; stats.hp+=100; resume(); };
        c.appendChild(el);
    }
}

function showUpgrade() {
    gameActive = false;
    let m = document.getElementById('menu-overlay'); 
    let c = document.getElementById('card-area');
    c.innerHTML = ''; 
    m.style.display = 'flex';
    document.querySelector('#menu-title').innerText = "LEVEL UP!";

    // 1. Âá∫ÁèæÊù°‰ª∂(condition)„ÇíÊ∫Ä„Åü„Åô„Ç¢„Ç§„ÉÜ„É†„Å†„Åë„ÇíÊäΩÂá∫
    let validPool = UPGRADE_DATA.filter(item => !item.condition || item.condition());
    
    // ‰∏á„Åå‰∏ÄÂÄôË£ú„ÅåÂ∞ë„Å™„Åô„Åé„ÇãÂ†¥Âêà„ÅÆÂÆâÂÖ®Á≠ñ
    if (validPool.length < 3) validPool = UPGRADE_DATA.slice(0, 5); // Âº∑Âºï„Å´Âü∫Êú¨„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÖ•„Çå„Çã

    // 2. „É©„É≥„ÉÄ„É†„Å´3„Å§ÈÅ∏Âá∫
    validPool.sort(() => Math.random() - 0.5);
    let choices = [];
    let pickedIds = new Set();
    
    for (let item of validPool) {
        if (choices.length >= 3) break;
        if (pickedIds.has(item.id)) continue; // IDÈáçË§áÂõûÈÅø
        
        // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí„Ç≥„Éî„Éº„Åó„Å¶‰ΩøÁî®ÔºàÂÖÉ„ÅÆ„Éá„Éº„Çø„ÇíÊ±ö„Åï„Å™„ÅÑ„Åü„ÇÅÔºâ
        let opt = { ...item };
        
        // 3. „É¨„Ç¢„É™„ÉÜ„Ç£Âà§ÂÆö (10%„ÅßÂäπÊûú2ÂÄç„ÄÅHP„Å™„Çâ3ÂÄç)
        if (Math.random() < 0.1) {
            opt.isRare = true;
            let mult = (opt.id === 'hp') ? 3 : 2;
            opt.val = Math.floor(opt.val * mult);
        }
        
        choices.push(opt);
        pickedIds.add(item.id);
    }

    // 4. „Ç´„Éº„ÉâÁîüÊàê
    choices.forEach(o => {
        let el = document.createElement('div'); 
        el.className = 'card';
        if(o.isRare) el.classList.add('rare');
        
        let title = o.isRare ? `‚ú® ${o.title}` : o.title;
        let desc = o.desc(o.val);
        
        el.innerHTML = `<span class="icon">${o.icon}</span><h3>${title}</h3><p>${desc}</p>`;
        el.onclick = () => { o.func(o.val); resume(); };
        c.appendChild(el);
    });
}

// ‚ñº‚ñº‚ñº „Åì„Åì„Åã„Çâ„Ç≥„Éî„Éº ‚ñº‚ñº‚ñº

// 1. ÂÖ±ÈÄö„ÅÆ„Ç´„Éº„ÉâÁîüÊàê„Éò„É´„Éë„ÉºÈñ¢Êï∞ („Åì„Çå„ÅåË∂≥„Çä„Å™„Åã„Å£„ÅüÈÉ®ÂàÜ„Åß„ÅôÔºÅ)
function createEvoCard(item, isSecond) {
    let el = document.createElement('div'); 
    el.className = 'card evo';
    // „Ç´„Éº„Éâ„ÅÆË¶ã„ÅüÁõÆ„Çí‰Ωú„Çã
    el.innerHTML = `<span class="icon">${item.icon}</span><h3>${item.title}</h3><p>${item.desc}</p>`;
    
    // „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂãï‰Ωú
    el.onclick = () => { 
        // Ëâ≤„Å®„ÇØ„É©„ÇπÂêç„ÇíÊõ¥Êñ∞
        player.color = item.color;
        let nameSpan = document.getElementById('disp-class-name');
        nameSpan.innerText = `(${item.title})`; 
        nameSpan.style.color = player.color;

        // „ÇØ„É©„ÇπIDË®≠ÂÆö (1Ê¨°ÈÄ≤Âåñ„Åã2Ê¨°ÈÄ≤Âåñ„Åã„ÅßÊõ∏„ÅçËæº„ÇÄÂ†¥ÊâÄ„ÇíÂ§â„Åà„Çã)
        if (isSecond) {
            player.subClass = item.id;
        } else {
            player.class = item.id;
        }

        // ÂÄãÂà•ÂäπÊûú„ÅÆÈÅ©Áî® (func„ÇíÂÆüË°å)
        if(item.func) item.func(); 
        
        resume(); 
    };
    return el;
}

// 2. Á¨¨1Ê¨°ÈÄ≤Âåñ (Level 5)
function showEvo() {
    gameActive = false;
    let m = document.getElementById('menu-overlay'); 
    let c = document.getElementById('card-area');
    c.innerHTML = ''; 
    m.style.display = 'flex';
    document.querySelector('#menu-title').innerText = "„ÇØ„É©„ÇπÈÄ≤Âåñ";

    // ÂÆöÁæ©„Éá„Éº„Çø(EVO_DATA)„Åã„Çâ„Ç´„Éº„Éâ„ÇíÁîüÊàê„Åó„Å¶‰∏¶„Åπ„Çã
    EVO_DATA.forEach(item => {
        c.appendChild(createEvoCard(item, false));
    });
}

// 3. Á¨¨2Ê¨°ÈÄ≤Âåñ (Level 40)
function showSecondEvo() {
    gameActive = false;
    let m = document.getElementById('menu-overlay'); 
    let c = document.getElementById('card-area');
    c.innerHTML = ''; 
    m.style.display = 'flex';
    document.querySelector('#menu-title').innerText = "Á¨¨2Ê¨°ÈÄ≤Âåñ (Class Evolution)";

    // ÁèæÂú®„ÅÆ„ÇØ„É©„Çπ„Åã„ÇâÊ¥æÁîü„Åô„ÇãÈÄ≤ÂåñÂÖà„Å†„Åë„ÇíÊäΩÂá∫
    let validEvos = SECOND_EVO_DATA.filter(item => item.parent === player.class);

    if(validEvos.length > 0) {
        validEvos.forEach(item => {
            c.appendChild(createEvoCard(item, true));
        });
    } else {
        // ‰∏á„Åå‰∏ÄÈÄ≤ÂåñÂÖà„Åå„Å™„ÅÑÂ†¥Âêà
        let el = document.createElement('div'); el.className='card milestone';
        el.innerHTML = `<h3>LIMIT BREAK</h3><p>ÂÖ®„Çπ„ÉÜ„Éº„Çø„ÇπÂº∑Âåñ</p>`;
        el.onclick = () => { stats.dmg*=1.5; stats.hp+=100; resume(); };
        c.appendChild(el);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ „Åì„Åì„Åæ„Åß„Ç≥„Éî„Éº ‚ñ≤‚ñ≤‚ñ≤

function resume() {
    document.getElementById('menu-overlay').style.display = 'none';
    lastTime = performance.now(); gameActive = true; updateSkillList(); requestAnimationFrame(loop);
}

function createParticles(x,y,c,n,sizeBase) { 
    if(particles.length > MAX_PARTICLES) return; 
    for(let i=0;i<n;i++) particles.push({ x:x, y:y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:10+Math.random()*5, size:(sizeBase||4)+Math.random()*2, color:c }); 
}

function updateStatsDisplay() {
    const s = stats;
    let atkPerSec = (60 / s.rate).toFixed(1); 
    
    let html = `
        ATK  : ${Math.floor(s.dmg)} <br>
        ASP  : ${atkPerSec}/s <br>
        CRIT : ${(s.critChance * 100).toFixed(0)}% <br>
        AREA : ${(s.areaScale * 100).toFixed(0)}% <br>
        SPD  : ${s.spd.toFixed(1)} <br>
        BSPD : ${s.bulletSpeed.toFixed(0)} <br>
        PIRC : ${s.pierce} <br>
        MAG  : ${Math.floor(s.magnet)} <br>
        ARM  : ${s.armor}
    `;
    
    if(s.duration > 1.0) html += `<br>DUR  : ${(s.duration*100).toFixed(0)}%`;
    if(s.knockback > 0) html += `<br>KBCK : ${s.knockback}`;

    document.getElementById('stats-list').innerHTML = html;
}

function updateUI() {
    document.getElementById('disp-lv').innerText = level;
    let hpPer = Math.max(0, player.hp / player.maxHp * 100);
    document.getElementById('hp-bar-fill').style.width = hpPer + '%';
    document.getElementById('disp-hp-val').innerText = Math.floor(player.hp);
    document.getElementById('disp-hp-max').innerText = Math.floor(player.maxHp);
    document.getElementById('disp-regen').innerText = stats.regen;
    document.getElementById('disp-score').innerText = score;

    updateStatsDisplay();
}

function updateSkillList() {
    let list = document.getElementById('skill-list');
    let html = "";
    if(singularityMode) html += `<div style="color:#000; text-shadow:0 0 5px #fff; font-weight:bold;">üåå SINGULARITY MODE</div>`;

    if(stats.omegaLaser) html += `<div style="color:#f0f">‚ö° OMEGA LASER</div>`;
    if(stats.absoluteZero) html += `<div style="color:#0ff">‚ùÑÔ∏è ZERO AURA</div>`;
    if(stats.titan) html += `<div style="color:#f00">ü¶ç TITAN</div>`;
    if(stats.gatling) html += `<div style="color:#0ff">‚öôÔ∏è GATLING</div>`;
    if(stats.railgun) html += `<div style="color:#ff0">üöÖ RAILGUN</div>`;
    
    // Guardian Skills
    if(stats.sentrySystem) html += `<div style="color:#0f0">üèóÔ∏è SENTRY SYS (${sentries.length})</div>`;
    if(stats.siegeMode) {
        let active = stats.isStationary ? "(ON)" : "(OFF)";
        html += `<div style="color:#0f0">üèØ SIEGE ${active}</div>`;
    }
    if(stats.reactiveArmor) html += `<div style="color:#0f0">‚ö° REACTIVE ARMOR</div>`;
    if(stats.forceField) {
        let ready = stats.forceFieldCd <= 0 ? "READY" : Math.ceil(stats.forceFieldCd/60)+"s";
        html += `<div style="color:#0ff">üõ°Ô∏è FORCE FIELD [${ready}]</div>`;
    }

    if(stats.chainBurst) html += `<div style="color:#0ff">üí• CHAIN BURST</div>`;
    if(stats.electroFence) html += `<div style="color:#0ff">‚ö° ELECTRO FENCE</div>`;
    if(stats.armor > 0) html += `<div style="color:#8f8">üõ°Ô∏è ARMOR +${stats.armor}</div>`;
    if(stats.shrapnel) html += `<div style="color:#ff0">üí• SHRAPNEL</div>`;

    if(stats.missile > 0) html += `<div style="color:#fa0">üöÄ „Éü„Çµ„Ç§„É´ Lv${stats.missile}</div>`;
    if(stats.drones > 0) html += `<div style="color:#ff0">üõ∞Ô∏è „Éâ„É≠„Éº„É≥ x${stats.drones}</div>`;
    if(stats.auraScale > 1) html += `<div style="color:#f00">üõ°Ô∏è „Ç™„Éº„É©ÂÄçÁéá x${stats.auraScale.toFixed(1)}</div>`;
    if(stats.lifesteal > 0) html += `<div style="color:#f0f">üßõ Âê∏Ë°Ä +${stats.lifesteal}</div>`;
    list.innerHTML = html;
}

function gameOver() {
    gameActive = false;
    document.getElementById('final-score').innerText = score;
    document.getElementById('game-over').style.display = 'flex';
}

function triggerWarning() {
    Sound.play('alert');
    let overlay = document.getElementById('warning-overlay');
    overlay.style.display = 'flex'; // CSS„Åßflex„É¨„Ç§„Ç¢„Ç¶„Éà„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅflex„Å´„Åô„Çã
}

updateUI();

// --- „Éó„É¨„Ç§„É§„ÉºÊèèÁîªÂ∞ÇÁî®Èñ¢Êï∞ (Âêë„ÅçÂõ∫ÂÆöÁâà) ---
function drawPlayerSprite(ctx, p) {
    ctx.save();
    ctx.translate(p.x, p.y);
    
    // Âêë„Åç„ÅÆÂõ∫ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
    if (typeof p.lastAngle === 'undefined') p.lastAngle = -Math.PI / 2;
    let angle = p.lastAngle;

    if (joyTouchId !== null && (joyMoveX !== 0 || joyMoveY !== 0)) {
        angle = Math.atan2(joyMoveY, joyMoveX);
        p.lastAngle = angle;
    } else {
        let dx = 0, dy = 0;
        if(keys['w'] || keys['ArrowUp']) dy -= 1;
        if(keys['s'] || keys['ArrowDown']) dy += 1;
        if(keys['a'] || keys['ArrowLeft']) dx -= 1;
        if(keys['d'] || keys['ArrowRight']) dx += 1;
        if (dx !== 0 || dy !== 0) {
            angle = Math.atan2(dy, dx);
            p.lastAngle = angle;
        }
    }

    // ÂÖ±ÈÄö„ÅÆÁô∫ÂÖâ„Ç®„Éï„Çß„ÇØ„ÉàÔºà„ÇØ„É©„ÇπÊåÅ„Å°„ÅÆÂ†¥ÂêàÔºâ
    if(p.class !== 'Novice') {
        ctx.shadowBlur = 8;
        ctx.shadowColor = p.color;
    }

    if (p.subClass) {
        drawSecondEvo(ctx, p, angle);
    } else if (p.class !== 'Novice') {
        drawFirstEvo(ctx, p, angle);
    } else {
        // Novice: „Ç∑„É≥„Éó„É´„Å™‰∫åÈáç„É™„É≥„Ç∞
        ctx.shadowBlur = 0;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
        let pulse = Math.sin(Date.now()*0.01)*2;
        ctx.beginPath(); ctx.arc(0, 0, p.size + 3 + pulse, 0, Math.PI*2); ctx.stroke();
    }

    ctx.restore();
}

// „Éò„É´„Éë„Éº: ÊåáÂÆö„Åï„Çå„ÅüÈ†ÇÁÇπÊï∞„ÅßÂ§öËßíÂΩ¢„ÇíÊèè„Åè
function drawPoly(ctx, r, sides, rot=0) {
    ctx.beginPath();
    for (let i = 0; i < sides; i++) {
        let a = (i * Math.PI * 2) / sides + rot;
        ctx.lineTo(Math.cos(a) * r, Math.sin(a) * r);
    }
    ctx.closePath();
}

// „Éò„É´„Éë„Éº: Èã≠„ÅÑ„Çπ„Éë„Ç§„ÇØ„ÇíÊèè„Åè
function drawSpike(ctx, length, width, offset=0) {
    ctx.beginPath();
    ctx.moveTo(offset + length, 0);
    ctx.lineTo(offset, width);
    ctx.lineTo(offset + length * 0.2, 0); // ËäØ
    ctx.lineTo(offset, -width);
    ctx.closePath();
}

// Á¨¨1Ê¨°ÈÄ≤Âåñ (Âπæ‰ΩïÂ≠¶„ÉªÊäΩË±°Âåñ)
function drawFirstEvo(ctx, p, angle) {
    let t = Date.now() / 1000;
    ctx.lineWidth = 2;

    switch (p.class) {
        case 'Samurai': // Èã≠Âà©„Å™„Äå„Åè„ÅÆÂ≠ó„Äç„Éñ„É¨„Éº„Éâ
            ctx.rotate(angle);
            ctx.fillStyle = p.color;
            ctx.strokeStyle = '#fff';
            // „É°„Ç§„É≥„Éñ„É¨„Éº„Éâ
            drawSpike(ctx, p.size * 2.5, p.size * 0.8, -p.size*0.5);
            ctx.fill(); ctx.stroke();
            // „Çµ„Éñ„Éñ„É¨„Éº„Éâ (ÈÄÜÂÅ¥)
            ctx.beginPath();
            ctx.moveTo(-p.size*0.5, 0);
            ctx.lineTo(-p.size*1.5, p.size*0.5);
            ctx.lineTo(-p.size*1.2, 0);
            ctx.lineTo(-p.size*1.5, -p.size*0.5);
            ctx.fill();
            break;

        case 'Assault': // 3„Å§„ÅÆ‰∏âËßíÂΩ¢„ÅåÂâçÈÄ≤„Åô„ÇãÂΩ¢ („Éà„É©„Ç§„Éá„É≥„Éà)
            ctx.rotate(angle);
            ctx.fillStyle = p.color;
            // ‰∏≠Â§Æ
            drawSpike(ctx, p.size*2.0, p.size*0.6, 0);
            ctx.fill();
            // Â∑¶Âè≥„ÅÆ„Ç¶„Ç§„É≥„Ç∞
            ctx.fillStyle = '#444'; ctx.strokeStyle = p.color;
            ctx.save(); ctx.translate(0, p.size); drawSpike(ctx, p.size*1.5, p.size*0.4, -p.size*0.5); ctx.fill(); ctx.stroke(); ctx.restore();
            ctx.save(); ctx.translate(0, -p.size); drawSpike(ctx, p.size*1.5, p.size*0.4, -p.size*0.5); ctx.fill(); ctx.stroke(); ctx.restore();
            break;

        case 'Sniper': // ‰ª•Ââç„Å®Âêå„ÅòÔºà„É¶„Éº„Ç∂„ÉºÂ•Ω„Åø„ÅÆÈã≠„ÅÑÁü¢Âç∞Ôºâ
            ctx.rotate(angle);
            ctx.fillStyle = p.color; 
            ctx.beginPath();
            ctx.moveTo(p.size * 2.5, 0);
            ctx.lineTo(-p.size, p.size * 0.7);
            ctx.lineTo(-p.size * 0.5, 0);
            ctx.lineTo(-p.size, -p.size * 0.7);
            ctx.closePath();
            ctx.fill();
            // „Ç≥„Ç¢
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-p.size, p.size*0.3); ctx.lineTo(-p.size, -p.size*0.3); ctx.fill();
            break;

        case 'Guardian': // Á©çÂ±§„Åô„ÇãÂÖ≠ËßíÂΩ¢ („Éò„Ç≠„Çµ„Ç¥„É≥„Éª„Ç≥„Ç¢)
            ctx.rotate(t * 0.5); // „ÇÜ„Å£„Åè„ÇäÂõûËª¢
            ctx.strokeStyle = p.color; ctx.lineWidth = 3;
            drawPoly(ctx, p.size * 1.2, 6, 0); ctx.stroke(); // Â§ñÊÆª
            
            ctx.rotate(-t * 1.0); // ÈÄÜÂõûËª¢
            ctx.fillStyle = p.color;
            drawPoly(ctx, p.size * 0.7, 6, 0); ctx.fill(); // Ê†∏
            break;

        case 'Tempest': // „Çπ„Éë„Éº„ÇØ„Åô„ÇãÊòüÂûãÂ§öËßíÂΩ¢
            // „ÇÆ„Ç∂„ÇÆ„Ç∂„ÅÆ„Ç™„Éº„É©
            ctx.strokeStyle = p.color;
            ctx.save(); ctx.rotate(t * 2);
            drawPoly(ctx, p.size * 1.3, 4, 0); ctx.stroke();
            ctx.rotate(Math.PI/4); drawPoly(ctx, p.size * 1.3, 4, 0); ctx.stroke();
            ctx.restore();
            // ‰∏≠ÂøÉ
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0,0, p.size*0.6, 0, Math.PI*2); ctx.fill();
            break;
            
        case 'Alchemist': // ËªåÈÅì„ÇíÊèè„ÅèÂàÜÂ≠êÊßãÈÄ†
            ctx.rotate(angle);
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(0,0, p.size*0.8, 0, Math.PI*2); ctx.fill(); // Ê†∏
            // Âë®Âõû„Åô„ÇãÁ≤íÂ≠ê
            ctx.fillStyle = '#fff';
            for(let i=0; i<3; i++) {
                let a = t * 3 + (i * Math.PI * 2 / 3);
                let dist = p.size * 1.5;
                ctx.beginPath(); ctx.arc(Math.cos(a)*dist, Math.sin(a)*dist, 3, 0, Math.PI*2); ctx.fill();
                // ËªåË∑°„É©„Ç§„É≥
                ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.arc(0,0, dist, 0, Math.PI*2); ctx.stroke();
            }
            break;

        case 'Trickster': // ‰∏çÂÆöÂΩ¢„ÉªÈùûÂØæÁß∞
            ctx.rotate(t);
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.moveTo(p.size, 0);
            ctx.lineTo(0, p.size);
            ctx.lineTo(-p.size * 0.5, 0); // ÈùûÂØæÁß∞„Å™ÂΩ¢
            ctx.lineTo(0, -p.size * 1.5);
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.stroke();
            break;
            
        default: // Vanguard„Å™„Å©
            ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI*2); ctx.fill();
            break;
    }
}

// Á¨¨2Ê¨°ÈÄ≤Âåñ („Çà„ÇäË§áÈõë„Å™Âπæ‰ΩïÂ≠¶„Ç®„Éï„Çß„ÇØ„Éà)
function drawSecondEvo(ctx, p, angle) {
    let t = Date.now() / 1000;
    ctx.shadowBlur = 15; 
    ctx.shadowColor = p.color;

    // --- ‚öîÔ∏è Samurai ---
    if (p.subClass === 'Ashura') {
        // Èòø‰øÆÁæÖ: ÊîæÂ∞ÑÁä∂„ÅÆÈã≠„ÅÑÊ£ò („Ç¶„ÉãÂûã)
        ctx.rotate(t * 5); // ÂÖ®‰ΩìÂõûËª¢
        ctx.fillStyle = p.color;
        for(let i=0; i<6; i++) {
            ctx.rotate(Math.PI*2/6);
            drawSpike(ctx, p.size*2.5, p.size*0.5, 0); ctx.fill();
        }
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,0, p.size*0.8, 0, Math.PI*2); ctx.fill();
    } 
    else if (p.subClass === 'Kensei') {
        // Ââ£ËÅñ: ÈùûÂ∏∏„Å´Èï∑„ÅÑ‰∏ÄÁõ¥Á∑ö„ÅÆÂÖâ („É¨„Éº„Ç∂„ÉºÁä∂)
        ctx.rotate(angle);
        ctx.fillStyle = '#fff';
        ctx.fillRect(-p.size*1.5, -2, p.size*6, 4); // ‰∏≠ÂøÉÁ∑ö
        // Âë®Âõ≤„ÅÆ„Éï„Ç£„Éº„É´„Éâ
        ctx.fillStyle = `rgba(100, 200, 255, 0.4)`;
        ctx.beginPath();
        ctx.moveTo(p.size*4, 0);
        ctx.lineTo(-p.size, p.size);
        ctx.lineTo(-p.size*0.5, 0);
        ctx.lineTo(-p.size, -p.size);
        ctx.fill();
    }

    // --- üî´ Assault ---
    else if (p.subClass === 'BulletStorm') {
        // „Éê„É¨„ÉÉ„Éà„Çπ„Éà„Éº„É†: „É™„É≥„Ç∞Áä∂„Å´‰∏¶„Çì„Å†‰∏âËßíÂΩ¢„ÅåÈ´òÈÄüÂõûËª¢
        ctx.rotate(angle);
        // „Ç≥„Ç¢
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0,0, p.size, 0, Math.PI*2); ctx.fill();
        // „É™„É≥„Ç∞„Éì„ÉÉ„Éà
        ctx.save(); ctx.rotate(t * 10);
        ctx.fillStyle = '#fff';
        for(let i=0; i<8; i++) {
            ctx.rotate(Math.PI*2/8);
            ctx.beginPath(); ctx.moveTo(p.size*1.8, 0); ctx.lineTo(p.size*1.2, 4); ctx.lineTo(p.size*1.2, -4); ctx.fill();
        }
        ctx.restore();
    }
    else if (p.subClass === 'ClusterStriker') {
        // „ÇØ„É©„Çπ„Çø„Éº: ÂõõËßí„ÅÑ„Éñ„É≠„ÉÉ„ÇØ„ÅåÂ±ïÈñã„ÉªÂèéÁ∏Æ
        ctx.rotate(angle);
        let pulse = Math.sin(t*10) * 5;
        ctx.fillStyle = '#f80';
        // 4„Å§„ÅÆ„Éñ„É≠„ÉÉ„ÇØ
        ctx.fillRect(5+pulse, 5+pulse, p.size, p.size);
        ctx.fillRect(5+pulse, -15-pulse, p.size, p.size);
        ctx.fillRect(-15-pulse, 5+pulse, p.size, p.size);
        ctx.fillRect(-15-pulse, -15-pulse, p.size, p.size);
        // „Ç≥„Ç¢
        ctx.fillStyle = '#fff'; ctx.fillRect(-5,-5, 10, 10);
    }

    // --- üî≠ Sniper ---
    else if (p.subClass === 'DimensionWalker') {
        // Ê¨°ÂÖÉ: „Ç∞„É™„ÉÉ„ÉÅ„Åô„ÇãÈã≠Âà©„Å™Á†¥Áâá
        ctx.rotate(angle);
        let drawShard = (col, offX) => {
            ctx.fillStyle = col;
            ctx.beginPath();
            ctx.moveTo(p.size*3.0 + offX, 0);
            ctx.lineTo(-p.size + offX, p.size);
            ctx.lineTo(0 + offX, 0);
            ctx.lineTo(-p.size + offX, -p.size);
            ctx.fill();
        };
        let shift = Math.random() * 6;
        drawShard('rgba(255,0,0,0.5)', shift);
        drawShard('rgba(0,0,255,0.5)', -shift);
        ctx.strokeStyle = '#fff'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(p.size*3,0); ctx.lineTo(-p.size, p.size); ctx.lineTo(0,0); ctx.lineTo(-p.size, -p.size); ctx.stroke();
    }
    else if (p.subClass === 'PrismShooter') {
        // „Éó„É™„Ç∫„É†: 3„Å§„ÅÆ„Å≤„ÅóÂΩ¢„ÅåÂõûËª¢„Åó„Å¶ÁµêÊô∂Âåñ
        ctx.rotate(t); 
        ctx.fillStyle = 'rgba(255, 0, 255, 0.6)'; ctx.strokeStyle = '#fff';
        for(let i=0; i<3; i++) {
            ctx.rotate(Math.PI*2/3);
            ctx.beginPath(); ctx.moveTo(0, -p.size*2); ctx.lineTo(p.size*0.8, 0); ctx.lineTo(0, p.size*2); ctx.lineTo(-p.size*0.8, 0); ctx.fill(); ctx.stroke();
        }
        // ‰∏≠ÂøÉ„Ç≥„Ç¢
        ctx.rotate(-t*2);
        ctx.fillStyle = '#fff'; drawPoly(ctx, p.size*0.5, 4, 0); ctx.fill();
    }

    // --- ‚ö° Tempest ---
    else if (p.subClass === 'Thor') {
        // „Éà„Éº„É´: ÂçÅÂ≠óÂûã„ÅÆÈ´ò„Ç®„Éç„É´„ÇÆ„Éº‰Ωì
        ctx.rotate(angle);
        ctx.fillStyle = '#ff0'; ctx.strokeStyle = '#fff'; ctx.lineWidth=3;
        // Ê®™Ê£í
        ctx.fillRect(-p.size, -p.size*2.5, p.size*2, p.size*5);
        ctx.strokeRect(-p.size, -p.size*2.5, p.size*2, p.size*5);
        // Â∏ØÈõª„Ç®„Éï„Çß„ÇØ„Éà
        if(Math.random() < 0.5) {
            ctx.strokeStyle = '#fff'; ctx.lineWidth=1;
            ctx.beginPath(); let r = p.size*3; for(let i=0; i<8; i++) ctx.lineTo((Math.random()-0.5)*r*2, (Math.random()-0.5)*r*2); ctx.stroke();
        }
    }
    else if (p.subClass === 'PlasmaLord') {
        // „Éó„É©„Ç∫„Éû: „ÇÜ„Çâ„ÇÅ„ÅèÂÜÜÁí∞„Å®„Ç≥„Ç¢
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#a0f'; ctx.lineWidth = 3;
        // „É©„É≥„ÉÄ„É†„Å´Ê≠™„ÇÄ„É™„É≥„Ç∞
        ctx.beginPath();
        for(let i=0; i<=10; i++) {
            let a = i * Math.PI*2 / 10;
            let r = p.size*2 + Math.sin(t*10 + i)*5;
            ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
        }
        ctx.closePath(); ctx.stroke();
    }

    // --- üß± Guardian ---
    else if (p.subClass === 'EarthShaker') {
        // „Ç¢„Éº„Çπ: Â∑®Â§ß„Å™Ê≠£ÊñπÂΩ¢„Éñ„É≠„ÉÉ„ÇØ„ÅÆÈõÜÂêà
        ctx.rotate(angle);
        ctx.fillStyle = '#640'; 
        // Â∑¶Âè≥„ÅÆË£ÖÁî≤
        ctx.fillRect(-p.size*2, -p.size*2, p.size*4, p.size*1.5);
        ctx.fillRect(-p.size*2, p.size*0.5, p.size*4, p.size*1.5);
        // ‰∏≠Â§Æ
        ctx.fillStyle = '#f80';
        ctx.fillRect(-p.size, -p.size*0.5, p.size*2, p.size);
    }
    else if (p.subClass === 'TeslaEngineer') {
        // „ÉÜ„Çπ„É©: ‰∏âËßíÂΩ¢„ÅÆ„Çø„ÉØ„Éº„Å®ÂõûËª¢„Åô„Çã„Ç¢„É≥„ÉÜ„Éä
        ctx.fillStyle = '#0ff';
        drawPoly(ctx, p.size*1.5, 3, 0); ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.arc(0,0, p.size*2, 0, Math.PI*2); ctx.stroke(); // „Éê„É™„Ç¢„É™„É≥„Ç∞
        // „Ç¢„É≥„ÉÜ„Éä
        ctx.rotate(t*5);
        ctx.fillStyle='#fff'; ctx.fillRect(-2, -p.size*2.5, 4, p.size*5);
    }

    // --- ‚öóÔ∏è Alchemist ---
    else if (p.subClass === 'NecroToxin') {
        // „Éç„ÇØ„É≠: ËÑàÊâì„Å§„Éê„Ç§„Ç™„Éè„Ç∂„Éº„Éâ„Éû„Éº„ÇØ
        ctx.rotate(t);
        ctx.fillStyle = '#0f0';
        for(let i=0; i<3; i++) {
            ctx.rotate(Math.PI*2/3);
            ctx.beginPath(); ctx.arc(0, p.size*1.5, p.size*0.8, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle='#050'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, p.size*1.5); ctx.stroke();
        }
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,0, p.size*0.5, 0, Math.PI*2); ctx.fill();
    }
    else if (p.subClass === 'MadScientist') {
        // „Éû„ÉÉ„Éâ: ‰∏çÂÆâÂÆö„Å´ÁÇπÊªÖ„Åô„ÇãÂ§öËßíÂΩ¢
        ctx.rotate(-t);
        let flicker = Math.random() > 0.5 ? '#f0f' : '#fff';
        ctx.strokeStyle = flicker; ctx.lineWidth = 4;
        drawPoly(ctx, p.size*1.8, 5, 0); ctx.stroke();
        ctx.fillStyle = flicker;
        drawPoly(ctx, p.size*0.8, 5, Math.PI); ctx.fill();
    }

    // --- üÉè Trickster ---
    else if (p.subClass === 'Gambler') {
        // „ÇÆ„É£„É≥„Éñ„É©„Éº: ÂõûËª¢„Åô„ÇãÊ≠£ÊñπÂΩ¢„ÉÅ„ÉÉ„Éó
        ctx.rotate(t*2);
        ctx.fillStyle = '#fd0'; ctx.fillRect(-p.size*1.2, -p.size*1.2, p.size*2.4, p.size*2.4);
        ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.strokeRect(-p.size, -p.size, p.size*2, p.size*2);
        // ÁõÆ
        ctx.fillStyle = '#000';
        ctx.beginPath(); ctx.arc(0,0, p.size*0.3, 0, Math.PI*2); ctx.fill();
    }
    else if (p.subClass === 'JokerMaster') {
        // „Ç∏„Éß„Éº„Ç´„Éº: „ÇÆ„Ç∂„ÇÆ„Ç∂„ÅÆÊòü
        let pulse = 1 + Math.sin(t*10)*0.2;
        ctx.scale(pulse, pulse);
        ctx.fillStyle = '#fff'; drawPoly(ctx, p.size*1.5, 8, t); ctx.fill();
        ctx.fillStyle = '#f0f'; drawPoly(ctx, p.size*1.0, 8, -t); ctx.fill();
    }

    // --- üõ°Ô∏è Vanguard ---
    else if (p.subClass === 'FlyingSwords') {
        // Âæ°Ââ£: Âπæ‰ΩïÂ≠¶ÁöÑ„Å™„Éï„Ç°„É≥„Éç„É´
        ctx.rotate(angle);
        ctx.fillStyle = '#f06';
        drawSpike(ctx, p.size*2, p.size*0.8, -p.size); ctx.fill();
        // Â∑¶Âè≥„Å´ÊµÆ„Åè„Éì„ÉÉ„Éà
        ctx.fillStyle = '#fff';
        ctx.fillRect(-p.size, p.size, p.size, 4);
        ctx.fillRect(-p.size, -p.size, p.size, 4);
    }
    else if (p.subClass === 'SunCrusher') {
        // Â§™ÈôΩ: ÁáÉ„Åà„Çã„Çà„ÅÜ„Å™Â§öÈáç„É™„É≥„Ç∞
        ctx.fillStyle = '#f50'; ctx.beginPath(); ctx.arc(0,0, p.size*1.2, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#fe0'; ctx.lineWidth=3;
        ctx.rotate(t*2);
        for(let i=0; i<4; i++) {
            ctx.rotate(Math.PI/4);
            ctx.strokeRect(-p.size*1.5, -p.size*1.5, p.size*3, p.size*3);
        }
    }
    
    // Fallback
    else {
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.stroke();
    }
    
    ctx.shadowBlur = 0; 
}
// ‚ñ≤‚ñ≤‚ñ≤ „Åì„Åì„Åæ„ÅßËøΩÂä†„Ç≥„Éº„Éâ (v4) ‚ñ≤‚ñ≤‚ñ≤
</script>
</body>
</html>
